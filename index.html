<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit OS Daily Ratio</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 600: '#475569', 200: '#e2e8f0' }
                    },
                    animation: {
                        'pulse-slow': 'pulse 3s cubic-bezier(0.4, 0, 0.6, 1) infinite',
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 4px; height: 4px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #475569; }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
        .glass { background: rgba(255, 255, 255, 0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); }
        .dark .glass { background: rgba(15, 23, 42, 0.85); }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-dark-900 dark:text-dark-200 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // âš ï¸ PASTE YOUR SUPABASE KEYS HERE
        // ==========================================
        const SUPABASE_URL = 'https://ncfgnaqfmuohblaedaka.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZmduYXFmbXVvaGJsYWVkYWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTI3MjksImV4cCI6MjA4NTYyODcyOX0.ygUbFJ9z7GQ3HG4SfOviMjMFc11TM0UQDoGuGGNk9lI'; 
        // ==========================================

        const { useState, useEffect, useMemo, useRef } = React;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ICONS ---
        const Icon = ({ children, size=20, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const ChevronLeft = p => <Icon {...p}><path d="m15 18-6-6 6-6"/></Icon>;
        const ChevronRight = p => <Icon {...p}><path d="m9 18 6-6 6-6"/></Icon>;
        const Check = p => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>;
        const Star = p => <Icon {...p}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></Icon>;
        const Plus = p => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Edit2 = p => <Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
        const X = p => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Cloud = p => <Icon {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M12 13.5V4"/><path d="m16 8-4-4-4 4"/></Icon>;
        const Moon = p => <Icon {...p}><path d="M12 3a6 6 0 0 0 9 9 9 0 1 1-9-9Z"/></Icon>;
        const Sun = p => <Icon {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></Icon>;
        const Clock = p => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Fire = p => <Icon {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.4 1.8-2.7 3-3.2v-.5c0 1.5 0 2.5 0 2.5z"/></Icon>;
        const Trophy = p => <Icon {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></Icon>;
        const ArrowUp = p => <Icon {...p}><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></Icon>;
        const ArrowDown = p => <Icon {...p}><line x1="12" y1="5" x2="12" y2="19"/><polyline points="19 12 12 19 5 12"/></Icon>;
        const Sort = p => <Icon {...p}><path d="m3 16 4 4 4-4"/><path d="M7 20V4"/><path d="m21 8-4-4-4 4"/><path d="M17 4v16"/></Icon>;
        const BarChart2 = p => <Icon {...p}><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></Icon>;
        const Grid = p => <Icon {...p}><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></Icon>;
        const CalendarIcon = p => <Icon {...p}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></Icon>;
        const Cake = p => <Icon {...p}><path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8"/><path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1"/><path d="M2 21h20"/><path d="M7 8v2"/><path d="M12 8v2"/><path d="M17 8v2"/><path d="M7 4h.01"/><path d="M12 4h.01"/><path d="M17 4h.01"/></Icon>;
        const Play = p => <Icon {...p}><polygon points="5 3 19 12 5 21 5 3"/></Icon>;
        const Pause = p => <Icon {...p}><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></Icon>;
        const Target = p => <Icon {...p}><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></Icon>;

        // --- CONSTANTS ---
        const COLORS = [
            { name: 'Slate', bg: 'bg-slate-100', text: 'text-slate-600', bar: 'bg-slate-500', dot: 'bg-slate-500', darkBg: 'dark:bg-slate-800', darkText: 'dark:text-slate-300' },
            { name: 'Red', bg: 'bg-red-100', text: 'text-red-600', bar: 'bg-red-500', dot: 'bg-red-500', darkBg: 'dark:bg-red-900/30', darkText: 'dark:text-red-400' },
            { name: 'Orange', bg: 'bg-orange-100', text: 'text-orange-600', bar: 'bg-orange-500', dot: 'bg-orange-500', darkBg: 'dark:bg-orange-900/30', darkText: 'dark:text-orange-400' },
            { name: 'Amber', bg: 'bg-amber-100', text: 'text-amber-600', bar: 'bg-amber-500', dot: 'bg-amber-500', darkBg: 'dark:bg-amber-900/30', darkText: 'dark:text-amber-400' },
            { name: 'Yellow', bg: 'bg-yellow-100', text: 'text-yellow-600', bar: 'bg-yellow-500', dot: 'bg-yellow-500', darkBg: 'dark:bg-yellow-900/30', darkText: 'dark:text-yellow-400' },
            { name: 'Lime', bg: 'bg-lime-100', text: 'text-lime-600', bar: 'bg-lime-500', dot: 'bg-lime-500', darkBg: 'dark:bg-lime-900/30', darkText: 'dark:text-lime-400' },
            { name: 'Emerald', bg: 'bg-emerald-100', text: 'text-emerald-600', bar: 'bg-emerald-500', dot: 'bg-emerald-500', darkBg: 'dark:bg-emerald-900/30', darkText: 'dark:text-emerald-400' },
            { name: 'Teal', bg: 'bg-teal-100', text: 'text-teal-600', bar: 'bg-teal-500', dot: 'bg-teal-500', darkBg: 'dark:bg-teal-900/30', darkText: 'dark:text-teal-400' },
            { name: 'Cyan', bg: 'bg-cyan-100', text: 'text-cyan-600', bar: 'bg-cyan-500', dot: 'bg-cyan-500', darkBg: 'dark:bg-cyan-900/30', darkText: 'dark:text-cyan-400' },
            { name: 'Sky', bg: 'bg-sky-100', text: 'text-sky-600', bar: 'bg-sky-500', dot: 'bg-sky-500', darkBg: 'dark:bg-sky-900/30', darkText: 'dark:text-sky-400' },
            { name: 'Blue', bg: 'bg-blue-100', text: 'text-blue-600', bar: 'bg-blue-500', dot: 'bg-blue-500', darkBg: 'dark:bg-blue-900/30', darkText: 'dark:text-blue-400' },
            { name: 'Indigo', bg: 'bg-indigo-100', text: 'text-indigo-600', bar: 'bg-indigo-500', dot: 'bg-indigo-500', darkBg: 'dark:bg-indigo-900/30', darkText: 'dark:text-indigo-400' },
            { name: 'Violet', bg: 'bg-violet-100', text: 'text-violet-600', bar: 'bg-violet-500', dot: 'bg-violet-500', darkBg: 'dark:bg-violet-900/30', darkText: 'dark:text-violet-400' },
            { name: 'Purple', bg: 'bg-purple-100', text: 'text-purple-600', bar: 'bg-purple-500', dot: 'bg-purple-500', darkBg: 'dark:bg-purple-900/30', darkText: 'dark:text-purple-400' },
            { name: 'Fuchsia', bg: 'bg-fuchsia-100', text: 'text-fuchsia-600', bar: 'bg-fuchsia-500', dot: 'bg-fuchsia-500', darkBg: 'dark:bg-fuchsia-900/30', darkText: 'dark:text-fuchsia-400' },
            { name: 'Rose', bg: 'bg-rose-100', text: 'text-rose-600', bar: 'bg-rose-500', dot: 'bg-rose-500', darkBg: 'dark:bg-rose-900/30', darkText: 'dark:text-rose-400' },
        ];
        const EMOJIS = ["âœï¸", "ðŸ’ª", "ðŸ“š", "ðŸ’§", "ðŸ§˜", "ðŸƒ", "ðŸ™", "ðŸ“±", "ðŸ¥¦", "ðŸ’Š", "ðŸ’°", "ðŸ§ ", "ðŸš­", "ðŸŽ¨", "ðŸŽ¸", "ðŸ§¹", "ðŸ¦·", "ðŸ¶", "ðŸŒ¿", "â°", "ðŸ’¤", "ðŸŒž", "ðŸŽ“", "ðŸ’¼", "ðŸ›’", "âš”ï¸", "ðŸ”¥", "ðŸ’Ž", "âœˆï¸", "ðŸš€", "ðŸŽµ", "ðŸ“·", "âš½", "ðŸ€", "ðŸ¥—", "ðŸ³", "ðŸº", "ðŸ·", "ðŸ ", "ðŸ›", "ðŸŽ", "â¤ï¸", "âœ¨", "ðŸ’¡", "ðŸ”Œ", "ðŸ”§", "ðŸ’Š", "ðŸ§¬", "ðŸ§¸", "ðŸš²", "ðŸ–ï¸", "ðŸ”ï¸", "ðŸ‘Ÿ", "ðŸ‘ž", "ðŸ’„", "ðŸ§´", "ðŸ§¼", "ðŸ“", "ðŸ“µ", "ðŸš­"];
        const CATEGORIES = ['All', 'Health', 'Work', 'Social', 'Learning', 'General'];
        const DAYS_OF_WEEK = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];
        const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        const isSameDayMonth = (date1, date2) => date1.getDate() === date2.getDate() && date1.getMonth() === date2.getMonth();
        const calculateStreak = (habitId, completions) => {
            let streak = 0; const today = new Date();
            for (let i = 0; i < 365; i++) {
                const d = new Date(); d.setDate(today.getDate() - i);
                if (completions[formatDateKey(d)]?.includes(habitId)) streak++; else if (i > 0) break;
            }
            return streak;
        };

        const MiniProgressBar = ({ value, max, colorClass }) => {
            const percentage = Math.min((value / max) * 100, 100);
            return (
                <div className="w-full bg-gray-100 dark:bg-dark-700 rounded-full h-1.5 mt-3 overflow-hidden">
                    <div className={`h-1.5 rounded-full transition-all duration-500 ease-out ${colorClass}`} style={{ width: `${percentage}%` }}></div>
                </div>
            );
        };

        const YearHeatmap = ({ completions, habits }) => {
            const heatmapRef = useRef(null);
            useEffect(() => { if (heatmapRef.current) heatmapRef.current.scrollLeft = heatmapRef.current.scrollWidth; }, [habits]);
            const data = useMemo(() => {
                const weeks = 52; const grid = []; const today = new Date();
                const dayOfWeek = today.getDay(); const endDate = new Date(today); endDate.setDate(today.getDate() + (6 - dayOfWeek));
                for (let w = weeks - 1; w >= 0; w--) {
                    const weekData = [];
                    for (let d = 0; d < 7; d++) {
                        const date = new Date(endDate); date.setDate(endDate.getDate() - (w * 7) - (6 - d));
                        const k = formatDateKey(date);
                        
                        // Strict Calculation for DENOMINATOR (Total for THAT day)
                        const dueHabits = habits.filter(h => { 
                            if (h.type === 'birthday' || h.type === 'event') return false; // Exclude non-tasks
                            if (h.type === 'task') return h.targetDate === k; // Task must be for this date
                            // Habit: check frequency
                            if ((!h.type || h.type === 'habit') && h.frequency && h.frequency.includes(date.getDay())) return true;
                            return false; 
                        });

                        const completedCount = (completions[k] || []).filter(id => habits.some(h => h.id === id && (h.type === 'habit' || h.type === 'task' || !h.type))).length;
                        const total = dueHabits.length || 1;
                        
                        // For display, if total was 0, percentage is 0 (or empty)
                        const val = dueHabits.length === 0 ? 0 : Math.min(completedCount / total, 1);
                        
                        weekData.push({ date: date, key: k, val: val, isFuture: date > new Date() });
                    }
                    grid.unshift(weekData);
                }
                return grid;
            }, [completions, habits]);
            return (
                <div ref={heatmapRef} className="h-full w-full overflow-x-auto overflow-y-hidden pb-1 scrollbar-thin flex flex-col justify-center">
                    <div className="flex gap-[3px] min-w-max px-2">{data.map((week, wIndex) => (<div key={wIndex} className="flex flex-col gap-[3px]">{week.map((day) => (<div key={day.key} title={`${day.key}: ${Math.round(day.val * 100)}%`} className={`w-[10px] h-[10px] md:w-[12px] md:h-[12px] rounded-[2px] transition-colors ${day.isFuture ? 'bg-transparent' : day.val === 0 ? 'bg-gray-100 dark:bg-dark-700' : day.val === 1 ? 'bg-emerald-500 shadow-[0_0_4px_rgba(16,185,129,0.5)]' : day.val >= 0.7 ? 'bg-emerald-400' : day.val >= 0.4 ? 'bg-emerald-300' : 'bg-emerald-200 dark:bg-emerald-900'}`}></div>))}</div>))}</div>
                </div>
            );
        };

        const ConsistencyChart = ({ completions, habits }) => {
            const data = useMemo(() => {
                const days = 30; const result = []; const today = new Date();
                for (let i = days - 1; i >= 0; i--) {
                    const d = new Date(); d.setDate(today.getDate() - i); const dateKey = formatDateKey(d);
                    
                    // Strict Calculation for DENOMINATOR (Total for THAT day)
                    const dueHabits = habits.filter(h => { 
                        if (h.type === 'birthday' || h.type === 'event') return false; // Exclude non-tasks
                        if (h.type === 'task') return h.targetDate === dateKey; // Task must be for this date
                        // Habit: check frequency
                        if ((!h.type || h.type === 'habit') && h.frequency && h.frequency.includes(d.getDay())) return true;
                        return false; 
                    });

                    // Count completed valid items
                    const completedCount = (completions[dateKey] || []).filter(id => habits.some(h => h.id === id && (h.type === 'habit' || h.type === 'task' || !h.type))).length;
                    
                    const totalDue = dueHabits.length || 1;
                    // If no tasks were due that day, value is 0 (empty bar)
                    const value = dueHabits.length === 0 ? 0 : Math.min(completedCount / totalDue, 1);
                    
                    result.push({ label: `${d.getMonth() + 1}/${d.getDate()}`, fullDate: d.toLocaleDateString(), value: value });
                }
                return result;
            }, [completions, habits]);
            return (
                <div className="h-full w-full overflow-x-auto pb-1 scrollbar-thin">
                    <div className="flex items-end h-full gap-2 min-w-max px-1">{data.map((d, i) => (<div key={i} className="flex flex-col items-center w-6 flex-shrink-0 h-full justify-end group"><div className="w-full h-full flex items-end relative bg-gray-50 dark:bg-dark-800 rounded-md overflow-hidden"><div className={`w-full rounded-b-md rounded-t-sm transition-all duration-500 ${d.value === 1 ? 'bg-emerald-400' : d.value >= 0.75 ? 'bg-indigo-400' : d.value >= 0.4 ? 'bg-indigo-300' : d.value > 0 ? 'bg-orange-300' : 'bg-transparent'}`} style={{ height: `${Math.max(d.value * 100, 0)}%` }}></div></div><span className="text-[9px] text-gray-400 mt-1.5 font-medium whitespace-nowrap">{d.label}</span></div>))}</div>
                </div>
            );
        };

        const FocusTimer = ({ habit, onClose, onComplete }) => {
            const [timeLeft, setTimeLeft] = useState(25 * 60);
            const [isActive, setIsActive] = useState(false);
            const formatTime = (seconds) => {
                const mins = Math.floor(seconds / 60);
                const secs = seconds % 60;
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            };
            useEffect(() => {
                let interval = null;
                if (isActive && timeLeft > 0) interval = setInterval(() => setTimeLeft(t => t - 1), 1000);
                else if (timeLeft === 0) { setIsActive(false); new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg').play().catch(()=>{}); }
                return () => clearInterval(interval);
            }, [isActive, timeLeft]);
            
            return (
                <div className="fixed inset-0 z-[60] flex items-center justify-center bg-dark-900 text-white modal-animate">
                    <button onClick={onClose} className="absolute top-6 right-6 p-2 text-gray-400 hover:text-white"><X size={32}/></button>
                    <div className="flex flex-col items-center gap-8">
                        <div className="text-xl font-medium text-indigo-400 flex items-center gap-2">{habit.icon} {habit.name}</div>
                        <div className="text-9xl font-bold font-mono tracking-tighter tabular-nums">{formatTime(timeLeft)}</div>
                        <div className="flex gap-6">
                            <button onClick={() => setIsActive(!isActive)} className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${isActive ? 'bg-orange-500 hover:bg-orange-600' : 'bg-emerald-500 hover:bg-emerald-600'}`}>
                                {isActive ? <Pause size={32} fill="currentColor" /> : <Play size={32} fill="currentColor" className="ml-1"/>}
                            </button>
                        </div>
                        {timeLeft === 0 && <button onClick={onComplete} className="px-8 py-3 bg-white text-dark-900 font-bold rounded-full animate-bounce">Complete Task</button>}
                    </div>
                </div>
            );
        };

        const HabitModal = ({ isOpen, onClose, onSave, initialData, onDelete }) => {
            const [name, setName] = useState('');
            const [icon, setIcon] = useState(EMOJIS[0]);
            const [color, setColor] = useState(COLORS[0]);
            const [type, setType] = useState('habit');
            const [category, setCategory] = useState('General');
            const [difficulty, setDifficulty] = useState('easy');
            const [useTimer, setUseTimer] = useState(false);
            const [monthlyGoal, setMonthlyGoal] = useState('');
            const [time, setTime] = useState('');
            const [frequency, setFrequency] = useState([0,1,2,3,4,5,6]); 
            const [targetDate, setTargetDate] = useState(formatDateKey(new Date()));

            useEffect(() => {
                if (isOpen) {
                    if (initialData) {
                        setName(initialData.name); setIcon(initialData.icon); setColor(initialData.color);
                        if(initialData.type) setType(initialData.type); else setType(initialData.isTask ? 'task' : 'habit');
                        setCategory(initialData.category || 'General');
                        setDifficulty(initialData.difficulty || 'easy');
                        setUseTimer(!!initialData.useTimer);
                        setMonthlyGoal(initialData.monthlyGoal || '');
                        setTime(initialData.time || ''); setFrequency(initialData.frequency || [0,1,2,3,4,5,6]); setTargetDate(initialData.targetDate || formatDateKey(new Date()));
                    } else {
                        setName(''); setIcon(EMOJIS[0]); setColor(COLORS[11]); setType('habit'); setCategory('General'); setDifficulty('easy'); setUseTimer(false); setMonthlyGoal(''); setTime(''); setFrequency([0,1,2,3,4,5,6]);
                    }
                }
            }, [isOpen, initialData]);

            const toggleDay = (dayIndex) => { if (frequency.includes(dayIndex)) setFrequency(frequency.filter(d => d !== dayIndex)); else setFrequency([...frequency, dayIndex].sort()); };
            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-xl w-full max-w-sm modal-animate overflow-hidden max-h-[90vh] overflow-y-auto">
                        <div className="px-6 py-4 border-b border-gray-100 dark:border-dark-700 flex justify-between items-center"><h3 className="font-bold text-gray-800 dark:text-gray-100">{initialData ? 'Edit' : 'New'}</h3><button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={20} /></button></div>
                        <form onSubmit={(e) => { e.preventDefault(); onSave({ id: initialData?.id, name, icon, color, type, category, difficulty, useTimer, monthlyGoal: parseInt(monthlyGoal) || 0, time, frequency, targetDate }); onClose(); }} className="p-6 space-y-5">
                            <div className="grid grid-cols-4 gap-1 bg-gray-100 dark:bg-dark-900 p-1 rounded-lg">
                                {['habit', 'task', 'event', 'birthday'].map(t => (<button key={t} type="button" onClick={() => setType(t)} className={`py-2 rounded-md text-[10px] font-bold uppercase transition-all ${type === t ? 'bg-white dark:bg-dark-700 shadow text-indigo-600 dark:text-indigo-400' : 'text-gray-400'}`}>{t === 'habit' ? 'Routine' : t}</button>))}
                            </div>
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Name</label><input autoFocus type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm dark:text-white" /></div>
                            
                            <div>
                                <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Category</label>
                                <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-thin">
                                    {CATEGORIES.slice(1).map(c => (
                                        <button key={c} type="button" onClick={() => setCategory(c)} className={`px-3 py-1.5 rounded-lg text-xs font-bold border whitespace-nowrap ${category === c ? 'bg-indigo-100 border-indigo-500 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400' : 'border-gray-200 dark:border-dark-700 text-gray-500'}`}>{c}</button>
                                    ))}
                                </div>
                            </div>

                            {(type === 'habit' || type === 'task') && (
                            <div className="space-y-4">
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Difficulty</label>
                                    <div className="flex gap-2">
                                        {['easy', 'medium', 'hard'].map(d => (<button key={d} type="button" onClick={() => setDifficulty(d)} className={`flex-1 py-2 rounded-lg text-xs font-bold border capitalize transition-all ${difficulty === d ? d==='hard' ? 'bg-yellow-50 border-yellow-500 text-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400' : 'bg-indigo-50 border-indigo-500 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400' : 'border-gray-200 dark:border-dark-700 text-gray-400'}`}>{d==='hard'?'Heroic':d}</button>))}
                                    </div>
                                </div>
                                <div className="flex gap-3">
                                    <div className="flex-1">
                                        <label className="block text-xs font-bold text-gray-400 uppercase mb-1">Monthly Goal (Opt)</label>
                                        <input type="number" placeholder="e.g. 15 times" value={monthlyGoal} onChange={e => setMonthlyGoal(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white" />
                                    </div>
                                    <div className="flex-1 flex items-end">
                                        <div onClick={() => setUseTimer(!useTimer)} className={`w-full flex items-center justify-center p-3 rounded-xl border cursor-pointer transition-colors ${useTimer ? 'bg-indigo-50 border-indigo-500 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400' : 'bg-gray-50 border-gray-200 dark:bg-dark-900 dark:border-dark-700 text-gray-500'}`}>
                                            <div className="flex items-center gap-2"><Clock size={16} /><span className="text-xs font-bold">Timer</span></div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            )}

                            <div className="flex gap-3">
                                <div className="flex-1"><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Time</label><input type="time" value={time} onChange={e => setTime(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white" /></div>
                                {(type !== 'habit') && <div className="flex-1"><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Date</label><input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white" /></div>}
                            </div>
                            
                            {type === 'habit' && (<div><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Frequency</label><div className="flex justify-between">{DAYS_OF_WEEK.map((d, i) => (<button key={i} type="button" onClick={() => toggleDay(i)} className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${frequency.includes(i) ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 dark:bg-dark-700 text-gray-400'}`}>{d}</button>))}</div></div>)}
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Icon</label><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">{EMOJIS.map(e => <button key={e} type="button" onClick={() => setIcon(e)} className={`flex-shrink-0 w-10 h-10 flex items-center justify-center text-xl rounded-lg ${icon === e ? 'bg-indigo-100 dark:bg-dark-700 border-2 border-indigo-500' : 'bg-gray-50 dark:bg-dark-900 dark:text-white'}`}>{e}</button>)}</div></div>
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Color</label><div className="flex flex-wrap gap-3">{COLORS.map(c => <button key={c.name} type="button" onClick={() => setColor(c)} className={`w-8 h-8 rounded-full ${c.dot} ${color.name === c.name ? 'ring-2 ring-offset-2 ring-gray-400' : ''}`} />)}</div></div>
                            <div className="flex gap-3 pt-2">{initialData && <button type="button" onClick={() => { onDelete(initialData.id); onClose(); }} className="flex-1 py-3 text-red-600 bg-red-50 dark:bg-red-900/20 rounded-xl text-sm font-bold">Delete</button>}<button type="submit" className="flex-[2] py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-md">Save</button></div>
                        </form>
                    </div>
                </div>
            );
        };

        const NoteModal = ({ isOpen, onClose, habit, streak, notes, onSaveNote }) => {
            const [note, setNote] = useState('');
            useEffect(() => { if (isOpen && notes) setNote(notes || ''); }, [isOpen, notes]);
            if (!isOpen || !habit) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full max-w-sm modal-animate p-6">
                        <div className="flex justify-between items-start mb-4"><div><div className="text-3xl mb-1">{habit.icon}</div><h2 className="text-xl font-bold dark:text-white">{habit.name}</h2></div></div>
                        <textarea placeholder="Add details..." value={note} onChange={e => setNote(e.target.value)} className="w-full h-32 p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm dark:text-gray-200 mb-4" />
                        <div className="flex gap-3"><button onClick={onClose} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button><button onClick={() => { onSaveNote(habit.id, note); onClose(); }} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">Save</button></div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [userId, setUserId] = useState(() => localStorage.getItem('habit_user_id') || `user_${Math.random().toString(36).substr(2, 9)}`);
            const [habits, setHabits] = useState([]);
            const [completions, setCompletions] = useState({});
            const [dailyNotes, setDailyNotes] = useState({});
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [status, setStatus] = useState('offline');
            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingHabit, setEditingHabit] = useState(null);
            const [detailHabit, setDetailHabit] = useState(null);
            const [isReorderMode, setIsReorderMode] = useState(false);
            const [chartMode, setChartMode] = useState('heatmap');
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [activeFocusHabit, setActiveFocusHabit] = useState(null);

            useEffect(() => { localStorage.setItem('habit_user_id', userId); }, [userId]);
            useEffect(() => { if (darkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); } else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); } }, [darkMode]);
            
            useEffect(() => {
                const fetchData = async () => {
                    setStatus('saving');
                    const { data, error } = await supabase.from('user_data').select('*').eq('user_id', userId).single();
                    if (data) {
                        setHabits(data.habits || []); setCompletions(data.completions || {});
                        if(data.completions && data.completions._notes) setDailyNotes(data.completions._notes);
                        setStatus('saved');
                    } else { await saveDataToSupabase(habits, completions, dailyNotes); }
                };
                fetchData();
            }, [userId]);

            const saveDataToSupabase = async (h, c, n) => {
                setStatus('saving');
                const payloadCompletions = { ...c, _notes: n };
                const { error } = await supabase.from('user_data').upsert({ user_id: userId, habits: h, completions: payloadCompletions });
                if (error) { console.error(error); setStatus('error'); } else setStatus('saved');
            };

            const updateData = (newHabits, newCompletions, newNotes) => {
                setHabits(newHabits); setCompletions(newCompletions); setDailyNotes(newNotes);
                saveDataToSupabase(newHabits, newCompletions, newNotes);
            };

            const handleSaveHabit = (habit) => { 
                const newHabits = habit.id && habits.some(h => h.id === habit.id) ? habits.map(h => h.id === habit.id ? habit : h) : [...habits, { ...habit, id: Date.now().toString(), order: habits.length }]; 
                updateData(newHabits, completions, dailyNotes); 
            };
            const handleDeleteHabit = (id) => updateData(habits.filter(h => h.id !== id), completions, dailyNotes);
            const handleSaveNote = (habitId, text) => { const key = `${habitId}_${formatDateKey(selectedDate)}`; const newNotes = { ...dailyNotes, [key]: text }; updateData(habits, completions, newNotes); };
            const toggleHabit = (id, dateKey) => { const current = completions[dateKey] || []; const newC = { ...completions, [dateKey]: current.includes(id) ? current.filter(x => x !== id) : [...current, id] }; updateData(habits, newC, dailyNotes); };
            
            const moveHabit = (id, direction) => {
                const index = habits.findIndex(h => h.id === id);
                if (index < 0) return;
                const newHabits = [...habits];
                const targetIndex = index + direction;
                if (targetIndex >= 0 && targetIndex < newHabits.length) {
                    const temp = newHabits[index].order || index;
                    newHabits[index].order = newHabits[targetIndex].order || targetIndex;
                    newHabits[targetIndex].order = temp;
                    [newHabits[index], newHabits[targetIndex]] = [newHabits[targetIndex], newHabits[index]];
                    updateData(newHabits, completions, dailyNotes);
                }
            };

            const year = currentDate.getFullYear(); const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate(); const firstDay = new Date(year, month, 1).getDay();
            const selectedDateKey = formatDateKey(selectedDate); const todayKey = formatDateKey(new Date());

            const getMonthCompletionCount = (habitId) => {
                let count = 0;
                for(let d=1; d<=daysInMonth; d++) {
                    const k = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    if(completions[k]?.includes(habitId)) count++;
                }
                return count;
            };
            
            // Calculate active categories
            const visibleCategories = useMemo(() => {
                const active = new Set(habits.map(h => h.category || 'General'));
                return ['All', ...CATEGORIES.slice(1).filter(c => active.has(c))];
            }, [habits]);

            const todaysHabits = habits.filter(h => {
                const type = h.type || (h.isTask ? 'task' : 'habit');
                const catMatch = selectedCategory === 'All' || (h.category === selectedCategory) || (!h.category && selectedCategory === 'General');
                if (!catMatch) return false;
                
                if (type === 'birthday') return isSameDayMonth(new Date(h.targetDate), selectedDate);
                if (type === 'task' || type === 'event') return h.targetDate === selectedDateKey;
                if (h.frequency && !h.frequency.includes(selectedDate.getDay())) return false;
                return true;
            }).sort((a, b) => {
                if (a.order !== undefined && b.order !== undefined) return a.order - b.order;
                if (a.time && !b.time) return -1; if (!a.time && b.time) return 1; if (a.time && b.time) return a.time.localeCompare(b.time); return 0;
            });

            // Get indicators for a specific date (dots)
            const getIndicators = (date) => {
                const k = formatDateKey(date); const dots = [];
                habits.forEach(h => {
                    const type = h.type || (h.isTask ? 'task' : 'habit');
                    let showDot = false; let color = 'bg-gray-300';
                    if (type === 'birthday' && isSameDayMonth(new Date(h.targetDate), date)) { showDot = true; color = 'bg-pink-400'; }
                    else if (type === 'event' && h.targetDate === k) { showDot = true; color = 'bg-blue-400'; }
                    else if (type === 'task' && h.targetDate === k) { showDot = true; color = 'bg-gray-400'; }
                    if (showDot) dots.push(color);
                });
                return dots.slice(0, 3);
            };

            useEffect(() => {
                if (todaysHabits.length > 0 && selectedDateKey === todayKey) {
                    const checkables = todaysHabits.filter(h => { const t = h.type || (h.isTask ? 'task' : 'habit'); return t === 'habit' || t === 'task'; });
                    if(checkables.length > 0) {
                        const completedCount = checkables.filter(h => completions[selectedDateKey]?.includes(h.id)).length;
                        if (completedCount === checkables.length) { confetti({ particleCount: 100, spread: 70, origin: { y: 0.6 } }); }
                    }
                }
            }, [completions, selectedDateKey]);

            const renderCalendar = () => {
                const days = []; for(let i=0; i<firstDay; i++) days.push(<div key={`empty-${i}`} className="h-full bg-gray-50/50 dark:bg-dark-900 border-b border-r border-gray-100 dark:border-dark-700"></div>);
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(year, month, d); const k = formatDateKey(date);
                    const dayData = completions[k] || []; const isToday = k === todayKey; const isSelected = k === selectedDateKey;
                    const indicators = getIndicators(date);
                    days.push(<div key={d} onClick={() => setSelectedDate(date)} className={`h-16 md:h-24 p-1 md:p-2 border-b border-r border-gray-100 dark:border-dark-700 cursor-pointer relative transition-colors ${isSelected ? 'bg-indigo-50/60 dark:bg-indigo-900/20' : 'hover:bg-gray-50 dark:hover:bg-dark-800'}`}>
                        <div className="flex justify-between items-center"><span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${isToday ? 'bg-indigo-600 text-white' : isSelected ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-500 dark:text-gray-400'}`}>{d}</span>{dayData.length > 0 && <div className="w-1.5 h-1.5 rounded-full bg-emerald-400"></div>}</div>
                        <div className="flex gap-1 mt-1 justify-end">{indicators.map((col, idx) => <div key={idx} className={`w-1.5 h-1.5 rounded-full ${col}`}></div>)}</div>
                        <div className="mt-1 flex flex-wrap gap-0.5">{dayData.slice(0, 3).map(id => { const h = habits.find(x => x.id === id); return h ? <span key={id} className="text-[10px]">{h.icon}</span> : null; })}</div>
                    </div>);
                }
                return days;
            };

            const longPressTimer = useRef(null);
            const handleTouchStart = (h) => { longPressTimer.current = setTimeout(() => { setDetailHabit(h); longPressTimer.current = null; }, 600); };
            const handleTouchEnd = () => { if (longPressTimer.current) { clearTimeout(longPressTimer.current); longPressTimer.current = null; } };

            return (
                <div className="flex flex-col md:flex-row h-screen overflow-hidden selection:bg-indigo-100 text-slate-800 dark:text-slate-200 font-sans">
                    {/* LEFT SIDEBAR */}
                    <div className="w-80 bg-white dark:bg-dark-800 border-r border-gray-200 dark:border-dark-700 hidden md:flex flex-col z-20">
                        <div className="p-6 border-b border-gray-100 dark:border-dark-700 flex items-center justify-between"><div className="flex items-center gap-3"><div className="bg-indigo-600 text-white p-2 rounded-lg"><Trophy size={20} /></div><div><h1 className="font-bold text-lg leading-tight dark:text-white">Habit OS</h1><p className="text-xs text-indigo-500 font-medium">{status === 'saving' ? 'Syncing...' : 'Cloud Active'}</p></div></div></div>
                        <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 mx-4 mt-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30"><p className="text-[10px] text-indigo-400 font-bold uppercase mb-1">Backup ID</p><p className="font-mono text-xs text-indigo-800 dark:text-indigo-300 break-all select-all cursor-pointer" onClick={() => navigator.clipboard.writeText(userId)}>{userId}</p><button onClick={() => {const c = prompt("Backup ID:"); if(c) {setUserId(c); window.location.reload();}}} className="text-[10px] text-indigo-500 underline mt-2">Restore?</button></div>
                        <div className="flex-1 overflow-y-auto p-4 scrollbar-thin"><div className="flex justify-between items-end mb-4 px-2"><h2 className="text-xs font-bold text-gray-400 uppercase tracking-wider">All Items</h2><button onClick={() => { setEditingHabit(null); setIsModalOpen(true); }} className="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-dark-700 p-1 rounded"><Plus size={18} /></button></div><div className="space-y-3">{habits.filter(h => (!h.type || h.type === 'habit')).map(h => { 
                            const monthlyCount = getMonthCompletionCount(h.id);
                            
                            return (<div key={h.id} className="group p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-700 border border-transparent hover:border-gray-100 dark:hover:border-dark-600 transition-all"><div className="flex items-center justify-between mb-1"><div className="flex items-center gap-3"><span className="text-xl">{h.icon}</span><span className="text-sm font-medium dark:text-gray-200">{h.name}</span></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-gray-400">{h.monthlyGoal > 0 ? `${monthlyCount} / ${h.monthlyGoal}` : ''}</span><button onClick={() => { setEditingHabit(h); setIsModalOpen(true); }} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-indigo-600"><Edit2 size={12} /></button></div></div>
                            
                            {h.monthlyGoal > 0 ? (
                                <MiniProgressBar value={monthlyCount} max={h.monthlyGoal} colorClass={h.color.bar} />
                            ) : (
                                <div className="mt-1 flex items-center text-[10px] text-gray-400 gap-1"><Fire size={12} className="text-orange-500" /> {calculateStreak(h.id, completions)} Day Streak</div>
                            )}
                            
                            </div>); 
                        })}</div></div>
                    </div>

                    {/* CENTER (Calendar) */}
                    <div className="flex-1 flex flex-col bg-white dark:bg-dark-900 h-[50%] md:h-full relative order-1">
                        <header className="glass px-4 md:px-6 py-3 md:py-4 flex items-center justify-between border-b border-gray-100 dark:border-dark-700 z-30 bg-white/80 dark:bg-dark-900/80 sticky top-0">
                            <div className="flex items-center gap-2 md:gap-4"><h2 className="text-lg md:text-xl font-bold text-gray-800 dark:text-white">{currentDate.toLocaleString('default', { month: 'long' })} {year}</h2><div className="flex bg-gray-100 dark:bg-dark-800 rounded-lg p-1"><button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="p-1 hover:bg-white dark:hover:bg-dark-700 rounded shadow-sm"><ChevronLeft size={16}/></button><button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="p-1 hover:bg-white dark:hover:bg-dark-700 rounded shadow-sm"><ChevronRight size={16}/></button></div></div>
                            <div className="flex items-center gap-3"><button onClick={() => setDarkMode(!darkMode)} className="p-2 text-gray-400 hover:text-indigo-500 transition-colors">{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button><button onClick={() => {const now=new Date(); setCurrentDate(now); setSelectedDate(now);}} className="text-xs font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-3 py-1.5 rounded-full">Today</button></div>
                        </header>
                        <div className="flex-1 overflow-auto min-h-0"><div className="grid grid-cols-7 border-b border-gray-100 dark:border-dark-700 sticky top-0 bg-white/95 dark:bg-dark-900/95 z-20 text-center py-2 text-xs font-bold text-gray-400 uppercase">{['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => <div key={d}>{d}</div>)}</div><div className="grid grid-cols-7 auto-rows-fr">{renderCalendar()}</div></div>
                        <div className="h-32 md:h-44 bg-white dark:bg-dark-900 border-t border-gray-100 dark:border-dark-700 p-2 md:p-4 flex flex-col flex-shrink-0 relative z-20">
                            <div className="flex items-center gap-2 mb-2 justify-between">
                                <div className="flex items-center gap-2"><Cloud size={16} className="text-gray-400" /><h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Consistency</h3></div>
                                <div className="flex bg-gray-100 dark:bg-dark-800 rounded p-0.5"><button onClick={() => setChartMode('bar')} className={`p-1 rounded ${chartMode === 'bar' ? 'bg-white dark:bg-dark-700 shadow text-indigo-500' : 'text-gray-400'}`}><BarChart2 size={14}/></button><button onClick={() => setChartMode('heatmap')} className={`p-1 rounded ${chartMode === 'heatmap' ? 'bg-white dark:bg-dark-700 shadow text-indigo-500' : 'text-gray-400'}`}><Grid size={14}/></button></div>
                            </div>
                            <div className="flex-1 min-h-0">{chartMode === 'heatmap' ? <YearHeatmap completions={completions} habits={habits} /> : <ConsistencyChart completions={completions} habits={habits} />}</div>
                        </div>
                    </div>

                    {/* RIGHT SIDEBAR (Agenda) */}
                    <div className="w-full md:w-96 bg-gray-50 dark:bg-dark-800/50 border-t md:border-t-0 md:border-l border-gray-200 dark:border-dark-700 flex flex-col z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:shadow-xl h-[50%] md:h-full order-2">
                        <div className="glass px-6 py-4 md:p-6 border-b border-gray-200/50 dark:border-dark-700 flex flex-col gap-3 sticky top-0 z-30">
                            <div className="flex justify-between items-center">
                                <div><h2 className="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">{selectedDate.toLocaleDateString('en-US', { weekday: 'long' })}</h2><p className="text-gray-500 dark:text-gray-400 text-xs md:text-sm">{selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p></div>
                                <div className="flex items-center gap-3"><button onClick={() => setIsReorderMode(!isReorderMode)} className={`p-2 rounded-lg transition-colors ${isReorderMode ? 'bg-indigo-100 text-indigo-600 dark:bg-indigo-900 dark:text-white' : 'text-gray-400 hover:text-gray-600'}`}><Sort size={20}/></button><div className="md:hidden"><button onClick={() => { setEditingHabit(null); setIsModalOpen(true); }} className="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><Plus size={18} /></button></div></div>
                            </div>
                            {/* Category Filter Pills (Dynamic) */}
                            <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-thin">
                                {visibleCategories.map(c => (
                                    <button key={c} onClick={() => setSelectedCategory(c)} className={`px-3 py-1 rounded-full text-[10px] font-bold uppercase transition-all whitespace-nowrap ${selectedCategory === c ? 'bg-gray-800 text-white dark:bg-white dark:text-black' : 'bg-white dark:bg-dark-700 text-gray-500 border border-gray-100 dark:border-dark-600'}`}>{c}</button>
                                ))}
                            </div>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-20 md:pb-6 scrollbar-thin">
                            {todaysHabits.length === 0 ? (<div className="text-center py-10 text-gray-400 dark:text-gray-600"><div className="text-4xl mb-2">ðŸ–ï¸</div><p className="text-sm font-medium">Nothing scheduled.</p></div>) : 
                            (<div className="space-y-3">{todaysHabits.map(h => { 
                                const isDone = completions[selectedDateKey]?.includes(h.id); 
                                const streak = calculateStreak(h.id, completions);
                                const type = h.type || (h.isTask ? 'task' : 'habit');
                                const isHeroic = h.difficulty === 'hard';
                                const isEvent = type === 'event' || type === 'birthday';
                                
                                return (
                                <div key={h.id} onMouseDown={() => handleTouchStart(h)} onMouseUp={handleTouchEnd} onMouseLeave={handleTouchEnd} onTouchStart={() => handleTouchStart(h)} onTouchEnd={handleTouchEnd} onClick={() => { if(!longPressTimer.current && !isReorderMode) toggleHabit(h.id, selectedDateKey); }} 
                                    className={`no-select relative group flex items-center p-3.5 rounded-2xl border transition-all duration-200 transform 
                                    ${isReorderMode ? 'border-indigo-300 dark:border-indigo-800' : 'cursor-pointer active:scale-95'}
                                    ${isHeroic && !isDone ? 'border-amber-400/50 bg-amber-50 dark:bg-amber-900/10 dark:border-amber-500/30' : ''}
                                    ${type === 'birthday' ? 'border-pink-200 bg-pink-50 dark:bg-pink-900/10 dark:border-pink-500/30' : ''}
                                    ${type === 'event' ? 'border-blue-200 bg-blue-50 dark:bg-blue-900/10 dark:border-blue-500/30' : ''}
                                    ${isDone ? 'bg-white/50 dark:bg-dark-700/50 border-transparent opacity-70' : (
                                        (type === 'habit' && !isHeroic) || type === 'task' ? 'bg-white dark:bg-dark-700 border-gray-100 dark:border-dark-600 shadow-sm' : 'shadow-md shadow-gray-100 dark:shadow-none'
                                    )}
                                    `}>
                                    
                                    {isReorderMode ? (
                                        <div className="flex flex-col gap-1 mr-3 text-gray-400"><button onClick={(e) => {e.stopPropagation(); moveHabit(h.id, -1)}} className="hover:text-indigo-600 p-1"><ArrowUp size={14}/></button><button onClick={(e) => {e.stopPropagation(); moveHabit(h.id, 1)}} className="hover:text-indigo-600 p-1"><ArrowDown size={14}/></button></div>
                                    ) : (
                                        <div className={`w-6 h-6 rounded-lg mr-3 flex items-center justify-center transition-colors ${isDone ? `${h.color.dot} text-white` : (type === 'birthday' ? 'bg-pink-100 text-pink-500 dark:bg-pink-900/30' : type === 'event' ? 'bg-blue-100 text-blue-500 dark:bg-blue-900/30' : isHeroic ? 'bg-amber-100 text-amber-500 dark:bg-amber-900/30' : 'bg-gray-100 dark:bg-dark-800 text-transparent')}`}>
                                            {isHeroic && !isDone ? <Star size={14} fill="currentColor" /> : type === 'birthday' ? <Cake size={14} /> : type === 'event' ? <CalendarIcon size={14} /> : <Check size={14} strokeWidth={3} />}
                                        </div>
                                    )}
                                    
                                    <div className="flex-1 min-w-0">
                                        <div className="flex items-center justify-between">
                                            <div className="flex items-center gap-2"><span className="text-lg">{h.icon}</span><span className={`text-sm font-bold truncate ${isDone ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-200'}`}>{h.name}</span></div>
                                            <div className="flex items-center gap-1">
                                                {/* Focus Button */}
                                                {!isDone && (type === 'habit' || type === 'task') && !isReorderMode && h.useTimer && 
                                                    <button onClick={(e) => { e.stopPropagation(); setActiveFocusHabit(h); }} className="p-1 text-gray-300 hover:text-indigo-500 transition-colors"><Play size={14} fill="currentColor" /></button>
                                                }
                                                {isHeroic && !isDone && <span className="text-[9px] font-black bg-gradient-to-r from-amber-400 to-orange-500 text-white px-1.5 py-0.5 rounded shadow-sm">HEROIC</span>}
                                                {type === 'birthday' && <span className="text-[9px] font-bold text-pink-500 bg-pink-100 dark:bg-pink-900/30 px-1.5 py-0.5 rounded">BDAY</span>}
                                                {!isDone && !isHeroic && !isEvent && streak > 2 && <div className="flex items-center text-[10px] font-bold text-orange-500 gap-0.5"><Fire size={12} /> {streak}</div>}
                                            </div>
                                        </div>
                                        <div className="flex items-center gap-2 mt-0.5">
                                            {h.time && <span className="flex items-center gap-1 text-[10px] font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-1.5 py-0.5 rounded"><Clock size={10} /> {h.time}</span>}
                                            {type === 'task' && <span className="text-[9px] font-bold bg-gray-100 dark:bg-dark-600 text-gray-500 px-1.5 py-0.5 rounded uppercase tracking-wide">Task</span>}
                                            {type === 'event' && <span className="text-[9px] font-bold bg-blue-100 dark:bg-blue-900/30 text-blue-500 px-1.5 py-0.5 rounded uppercase tracking-wide">Event</span>}
                                            {h.category && h.category !== 'General' && <span className="text-[9px] font-bold text-gray-400 uppercase tracking-wide border border-gray-100 dark:border-dark-600 px-1.5 py-0.5 rounded">{h.category}</span>}
                                        </div>
                                    </div>
                                </div>); 
                            })}</div>)}
                            <div className="md:hidden pt-8 text-center mt-4"><p className="text-[10px] text-gray-300 dark:text-dark-600 font-mono mb-1">{userId}</p><button onClick={() => {const c = prompt("Backup ID:"); if(c) {setUserId(c); window.location.reload();}}} className="text-[10px] text-gray-400 underline">Restore Data</button></div>
                        </div>
                        <div className="hidden md:block p-4 border-t border-gray-200 dark:border-dark-700 bg-white dark:bg-dark-900"><button onClick={() => { setEditingHabit(null); setIsModalOpen(true); }} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition-transform hover:-translate-y-0.5">+ Add Item</button></div>
                    </div>
                    
                    {/* MODALS */}
                    <HabitModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveHabit} onDelete={handleDeleteHabit} initialData={editingHabit} />
                    <NoteModal isOpen={!!detailHabit} onClose={() => setDetailHabit(null)} habit={detailHabit} streak={detailHabit ? calculateStreak(detailHabit.id, completions) : 0} notes={detailHabit ? dailyNotes[`${detailHabit.id}_${selectedDateKey}`] : ''} onSaveNote={handleSaveNote} />
                    {activeFocusHabit && <FocusTimer habit={activeFocusHabit} onClose={() => setActiveFocusHabit(null)} onComplete={() => { toggleHabit(activeFocusHabit.id, selectedDateKey); setActiveFocusHabit(null); }} />}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
