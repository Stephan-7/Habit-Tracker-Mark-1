<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Habit OS Stable Pro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

  <!-- Tailwind -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- React -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <!-- Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <!-- Confetti -->
  <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>

  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: {
            dark: {
              900: '#0f172a',
              800: '#1e293b',
              700: '#334155',
              600: '#475569',
              200: '#e2e8f0',
            },
          },
        },
      },
    };
  </script>

  <style>
    .scrollbar-thin::-webkit-scrollbar {
      width: 4px;
      height: 4px;
    }
    .scrollbar-thin::-webkit-scrollbar-track {
      background: transparent;
    }
    .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #cbd5e1;
      border-radius: 20px;
    }
    .dark .scrollbar-thin::-webkit-scrollbar-thumb {
      background-color: #475569;
    }
    .modal-animate {
      animation: fadeIn 0.2s ease-out forwards;
    }
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: scale(0.95);
      }
      to {
        opacity: 1;
        transform: scale(1);
      }
    }
    .no-select {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      user-select: none;
    }
    .glass {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
    }
    .dark .glass {
      background: rgba(15, 23, 42, 0.85);
    }
  </style>
</head>

<body class="bg-gray-50 text-gray-900 dark:bg-dark-900 dark:text-dark-200 transition-colors duration-300">
  <div id="root"></div>

  <script type="text/babel">
    // =========================
    // SUPABASE CONFIG (FILL IN)
    // =========================
    // TODO: Replace with your Supabase project URL and anon key
    const SUPABASE_URL = 'https://ncfgnaqfmuohblaedaka.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZmduYXFmbXVvaGJsYWVkYWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTI3MjksImV4cCI6MjA4NTYyODcyOX0.ygUbFJ9z7GQ3HG4SfOviMjMFc11TM0UQDoGuGGNk9lI';

    const { useState, useEffect, useMemo, useRef } = React;
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    // =========================
    // ICON COMPONENTS
    // =========================
    const Icon = ({ children, size = 20, className = '', fill = 'none' }) => (
      <svg
        xmlns="http://www.w3.org/2000/svg"
        width={size}
        height={size}
        viewBox="0 0 24 24"
        fill={fill}
        stroke="currentColor"
        strokeWidth="2"
        strokeLinecap="round"
        strokeLinejoin="round"
        className={className}
      >
        {children}
      </svg>
    );

    const ChevronLeft = (p) => (
      <Icon {...p}>
        <path d="m15 18-6-6 6-6" />
      </Icon>
    );
    const ChevronRight = (p) => (
      <Icon {...p}>
        <path d="m9 18 6-6-6-6" />
      </Icon>
    );
    const Check = (p) => (
      <Icon {...p}>
        <polyline points="20 6 9 17 4 12" />
      </Icon>
    );
    const Star = (p) => (
      <Icon {...p}>
        <polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2" />
      </Icon>
    );
    const Plus = (p) => (
      <Icon {...p}>
        <path d="M5 12h14" />
        <path d="M12 5v14" />
      </Icon>
    );
    const Edit2 = (p) => (
      <Icon {...p}>
        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z" />
      </Icon>
    );
    const X = (p) => (
      <Icon {...p}>
        <path d="M18 6 6 18" />
        <path d="m6 6 12 12" />
      </Icon>
    );
    const Cloud = (p) => (
      <Icon {...p}>
        <path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19" />
        <path d="M12 13.5V4" />
        <path d="m16 8-4-4-4 4" />
      </Icon>
    );
    const Moon = (p) => (
      <Icon {...p}>
        <path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z" />
      </Icon>
    );
    const Sun = (p) => (
      <Icon {...p}>
        <circle cx="12" cy="12" r="4" />
        <path d="M12 2v2" />
        <path d="M12 20v2" />
        <path d="m4.93 4.93 1.41 1.41" />
        <path d="m17.66 17.66 1.41 1.41" />
        <path d="M2 12h2" />
        <path d="M20 12h2" />
        <path d="m6.34 17.66-1.41 1.41" />
        <path d="m19.07 4.93-1.41 1.41" />
      </Icon>
    );
    const Clock = (p) => (
      <Icon {...p}>
        <circle cx="12" cy="12" r="10" />
        <polyline points="12 6 12 12 16 14" />
      </Icon>
    );
    const Fire = (p) => (
      <Icon {...p}>
        <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.4 1.8-2.7 3-3.2v-.5c0 1.5 0 2.5 0 2.5z" />
      </Icon>
    );
    const Trophy = (p) => (
      <Icon {...p}>
        <path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6" />
        <path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18" />
        <path d="M4 22h16" />
        <path d="M10 14.66V17c0 .55-.48.98-.98 1.21C7.85 18.75 7 20.24 7 22" />
        <path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22" />
        <path d="M18 2H6v7a6 6 0 0 0 12 0V2Z" />
      </Icon>
    );
    const ArrowUp = (p) => (
      <Icon {...p}>
        <line x1="12" y1="19" x2="12" y2="5" />
        <polyline points="5 12 12 5 19 12" />
      </Icon>
    );
    const ArrowDown = (p) => (
      <Icon {...p}>
        <line x1="12" y1="5" x2="12" y2="19" />
        <polyline points="19 12 12 19 5 12" />
      </Icon>
    );
    const Sort = (p) => (
      <Icon {...p}>
        <path d="m3 16 4 4 4-4" />
        <path d="M7 20V4" />
        <path d="m21 8-4-4-4 4" />
        <path d="M17 4v16" />
      </Icon>
    );
    const BarChart2 = (p) => (
      <Icon {...p}>
        <line x1="18" y1="20" x2="18" y2="10" />
        <line x1="12" y1="20" x2="12" y2="4" />
        <line x1="6" y1="20" x2="6" y2="14" />
      </Icon>
    );
    const Grid = (p) => (
      <Icon {...p}>
        <rect x="3" y="3" width="7" height="7" />
        <rect x="14" y="3" width="7" height="7" />
        <rect x="14" y="14" width="7" height="7" />
        <rect x="3" y="14" width="7" height="7" />
      </Icon>
    );
    const CalendarIcon = (p) => (
      <Icon {...p}>
        <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
        <line x1="16" y1="2" x2="16" y2="6" />
        <line x1="8" y1="2" x2="8" y2="6" />
        <line x1="3" y1="10" x2="21" y2="10" />
      </Icon>
    );
    const Cake = (p) => (
      <Icon {...p}>
        <path d="M20 21v-8a2 2 0 0 0-2-2H6a2 2 0 0 0-2 2v8" />
        <path d="M4 16s.5-1 2-1 2.5 2 4 2 2.5-2 4-2 2.5 2 4 2 2-1 2-1" />
        <path d="M2 21h20" />
        <path d="M7 8v2" />
        <path d="M12 8v2" />
        <path d="M17 8v2" />
        <path d="M7 4h.01" />
        <path d="M12 4h.01" />
        <path d="M17 4h.01" />
      </Icon>
    );
    const Play = (p) => (
      <Icon {...p}>
        <polygon points="5 3 19 12 5 21 5 3" />
      </Icon>
    );
    const Pause = (p) => (
      <Icon {...p}>
        <rect x="6" y="4" width="4" height="16" />
        <rect x="14" y="4" width="4" height="16" />
      </Icon>
    );
    const Settings = (p) => (
      <Icon {...p}>
        <path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.1a2 2 0 0 1-1-1.74v-.47a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z" />
        <circle cx="12" cy="12" r="3" />
      </Icon>
    );
    const Archive = (p) => (
      <Icon {...p}>
        <rect width="20" height="5" x="2" y="3" rx="1" />
        <path d="M4 8v11a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8" />
        <path d="M10 12h4" />
      </Icon>
    );
    const Download = (p) => (
      <Icon {...p}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="7 10 12 15 17 10" />
        <line x1="12" x2="12" y1="15" y2="3" />
      </Icon>
    );
    const Upload = (p) => (
      <Icon {...p}>
        <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" />
        <polyline points="17 8 12 3 7 8" />
        <line x1="12" x2="12" y1="3" y2="15" />
      </Icon>
    );
    const Trash2 = (p) => (
      <Icon {...p}>
        <path d="M3 6h18" />
        <path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" />
        <path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" />
        <line x1="10" x2="10" y1="11" y2="17" />
        <line x1="14" x2="14" y1="11" y2="17" />
      </Icon>
    );
    const RotateCcw = (p) => (
      <Icon {...p}>
        <path d="M3 12a9 9 0 1 0 9-9 9.75 9.75 0 0 0-6.74 2.74L3 8" />
        <path d="M3 3v5h5" />
      </Icon>
    );

    // =========================
    // CONSTANTS
    // =========================
    const COLORS = [
      { name: 'Slate', bg: 'bg-slate-100', text: 'text-slate-600', bar: 'bg-slate-500', dot: 'bg-slate-500', darkBg: 'dark:bg-slate-800', darkText: 'dark:text-slate-300' },
      { name: 'Red', bg: 'bg-red-100', text: 'text-red-600', bar: 'bg-red-500', dot: 'bg-red-500', darkBg: 'dark:bg-red-900/30', darkText: 'dark:text-red-400' },
      { name: 'Orange', bg: 'bg-orange-100', text: 'text-orange-600', bar: 'bg-orange-500', dot: 'bg-orange-500', darkBg: 'dark:bg-orange-900/30', darkText: 'dark:text-orange-400' },
      { name: 'Amber', bg: 'bg-amber-100', text: 'text-amber-600', bar: 'bg-amber-500', dot: 'bg-amber-500', darkBg: 'dark:bg-amber-900/30', darkText: 'dark:text-amber-400' },
      { name: 'Yellow', bg: 'bg-yellow-100', text: 'text-yellow-600', bar: 'bg-yellow-500', dot: 'bg-yellow-500', darkBg: 'dark:bg-yellow-900/30', darkText: 'dark:text-yellow-400' },
      { name: 'Lime', bg: 'bg-lime-100', text: 'text-lime-600', bar: 'bg-lime-500', dot: 'bg-lime-500', darkBg: 'dark:bg-lime-900/30', darkText: 'dark:text-lime-400' },
      { name: 'Emerald', bg: 'bg-emerald-100', text: 'text-emerald-600', bar: 'bg-emerald-500', dot: 'bg-emerald-500', darkBg: 'dark:bg-emerald-900/30', darkText: 'dark:text-emerald-400' },
      { name: 'Teal', bg: 'bg-teal-100', text: 'text-teal-600', bar: 'bg-teal-500', dot: 'bg-teal-500', darkBg: 'dark:bg-teal-900/30', darkText: 'dark:text-teal-400' },
      { name: 'Cyan', bg: 'bg-cyan-100', text: 'text-cyan-600', bar: 'bg-cyan-500', dot: 'bg-cyan-500', darkBg: 'dark:bg-cyan-900/30', darkText: 'dark:text-cyan-400' },
      { name: 'Sky', bg: 'bg-sky-100', text: 'text-sky-600', bar: 'bg-sky-500', dot: 'bg-sky-500', darkBg: 'dark:bg-sky-900/30', darkText: 'dark:text-sky-400' },
      { name: 'Blue', bg: 'bg-blue-100', text: 'text-blue-600', bar: 'bg-blue-500', dot: 'bg-blue-500', darkBg: 'dark:bg-blue-900/30', darkText: 'dark:text-blue-400' },
      { name: 'Indigo', bg: 'bg-indigo-100', text: 'text-indigo-600', bar: 'bg-indigo-500', dot: 'bg-indigo-500', darkBg: 'dark:bg-indigo-900/30', darkText: 'dark:text-indigo-400' },
      { name: 'Violet', bg: 'bg-violet-100', text: 'text-violet-600', bar: 'bg-violet-500', dot: 'bg-violet-500', darkBg: 'dark:bg-violet-900/30', darkText: 'dark:text-violet-400' },
      { name: 'Purple', bg: 'bg-purple-100', text: 'text-purple-600', bar: 'bg-purple-500', dot: 'bg-purple-500', darkBg: 'dark:bg-purple-900/30', darkText: 'dark:text-purple-400' },
      { name: 'Fuchsia', bg: 'bg-fuchsia-100', text: 'text-fuchsia-600', bar: 'bg-fuchsia-500', dot: 'bg-fuchsia-500', darkBg: 'dark:bg-fuchsia-900/30', darkText: 'dark:text-fuchsia-400' },
      { name: 'Rose', bg: 'bg-rose-100', text: 'text-rose-600', bar: 'bg-rose-500', dot: 'bg-rose-500', darkBg: 'dark:bg-rose-900/30', darkText: 'dark:text-rose-400' },
    ];

    const EMOJIS = [
      'ðŸ”¥', 'âœ…', 'ðŸ“š', 'ðŸƒâ€â™‚ï¸', 'ðŸ’ª', 'ðŸ§ ', 'ðŸ§˜â€â™‚ï¸', 'ðŸ’»', 'ðŸ“ˆ', 'ðŸŒž', 'ðŸŒ™', 'ðŸŽ', 'â˜•ï¸', 'ðŸ’§', 'ðŸŽ§', 'ðŸ“–', 'ðŸ“', 'ðŸŽ¯', 'ðŸ†', 'ðŸ§¹',
      'ðŸ§º', 'ðŸš¿', 'ðŸ›ï¸', 'ðŸš¶â€â™‚ï¸', 'ðŸ’¼', 'ðŸ¤', 'ðŸ“…', 'ðŸŽ®', 'ðŸŽ¹', 'ðŸŽ¨', 'ðŸ§©', 'ðŸ§ª', 'ðŸ§¬', 'ðŸ§—â€â™‚ï¸', 'ðŸš´â€â™‚ï¸', 'ðŸŠâ€â™‚ï¸', 'ðŸ¥—', 'ðŸ½ï¸', 'ðŸ§´',
    ];

    const CATEGORIES = ['All', 'Health', 'Work', 'Social', 'Learning', 'General'];
    const DAYS_OF_WEEK = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

    const formatDateKey = (date) => {
      return `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(
        date.getDate()
      ).padStart(2, '0')}`;
    };

    const isSameDayMonth = (date1, date2) =>
      date1.getDate() === date2.getDate() && date1.getMonth() === date2.getMonth();

    // =========================
    // HELPERS
    // =========================
    const calculateStreak = (habitId, completions, vacationMode) => {
      let streak = 0;
      const today = new Date();
      for (let i = 0; i < 365; i++) {
        const d = new Date();
        d.setDate(today.getDate() - i);
        const k = formatDateKey(d);
        if ((completions[k] || []).includes(habitId)) {
          streak++;
        } else if (vacationMode) {
          continue;
        } else if (i > 0) {
          break;
        }
      }
      return streak;
    };

    const MiniProgressBar = ({ value, max, colorClass }) => {
      const percentage = max > 0 ? Math.min((value / max) * 100, 100) : 0;
      return (
        <div className="w-full bg-gray-100 dark:bg-dark-700 rounded-full h-1.5 mt-3 overflow-hidden">
          <div
            className={`h-1.5 rounded-full transition-all duration-500 ease-out ${colorClass}`}
            style={{ width: `${percentage}%` }}
          ></div>
        </div>
      );
    };

    const isHabitDueOnDate = (h, date, dateKey) => {
      if (h.type === 'birthday' || h.type === 'event') return false;
      if (h.type === 'task') return h.targetDate === dateKey;
      const freq = h.frequency || [0, 1, 2, 3, 4, 5, 6];
      if (h.type === 'habit' && !freq.includes(date.getDay())) return false;
      return true;
    };

    // =========================
    // HEATMAP
    // =========================
    const YearHeatmap = ({ completions, habits }) => {
      const heatmapRef = useRef(null);

      useEffect(() => {
        if (heatmapRef.current) {
          heatmapRef.current.scrollLeft = heatmapRef.current.scrollWidth;
        }
      }, [habits]);

      const data = useMemo(() => {
        const weeks = 52;
        const grid = [];
        const today = new Date();
        const dayOfWeek = today.getDay();
        const endDate = new Date(today);
        endDate.setDate(today.getDate() + (6 - dayOfWeek));

        for (let w = weeks - 1; w >= 0; w--) {
          const weekData = [];
          for (let d = 0; d < 7; d++) {
            const date = new Date(endDate);
            date.setDate(endDate.getDate() - w * 7 - (6 - d));
            const k = formatDateKey(date);

            const dueHabits = habits.filter((h) => !h.archived && isHabitDueOnDate(h, date, k));
            const completedCount = (completions[k] || []).filter((id) =>
              habits.some((h) => h.id === id && isHabitDueOnDate(h, date, k))
            ).length;
            const total = dueHabits.length;
            const val = total === 0 ? 0 : completedCount / total;

            weekData.push({
              date,
              key: k,
              val,
              isFuture: date > new Date(),
            });
          }
          grid.unshift(weekData);
        }
        return grid;
      }, [completions, habits]);

      return (
        <div
          ref={heatmapRef}
          className="h-full w-full overflow-x-auto overflow-y-hidden pb-1 scrollbar-thin flex flex-col justify-center"
        >
          <div className="flex gap-[3px] min-w-max px-2">
            {data.map((week, wIndex) => (
              <div key={wIndex} className="flex flex-col gap-[3px]">
                {week.map((day) => (
                  <div
                    key={day.key}
                    title={`${day.key}: ${Math.round(day.val * 100)}%`}
                    className={`w-[10px] h-[10px] md:w-[12px] md:h-[12px] rounded-[2px] transition-colors ${
                      day.isFuture
                        ? 'bg-transparent'
                        : day.val === 0
                        ? 'bg-gray-100 dark:bg-dark-700'
                        : day.val >= 1
                        ? 'bg-emerald-500 shadow-[0_0_4px_rgba(16,185,129,0.5)]'
                        : day.val >= 0.7
                        ? 'bg-emerald-400'
                        : day.val >= 0.4
                        ? 'bg-emerald-300'
                        : 'bg-emerald-200 dark:bg-emerald-900'
                    }`}
                  ></div>
                ))}
              </div>
            ))}
          </div>
        </div>
      );
    };

    // =========================
    // CONSISTENCY CHART
    // =========================
    const ConsistencyChart = ({ completions, habits }) => {
      const data = useMemo(() => {
        const days = 30;
        const result = [];
        const today = new Date();
        for (let i = days - 1; i >= 0; i--) {
          const d = new Date();
          d.setDate(today.getDate() - i);
          const dateKey = formatDateKey(d);
          const dueHabits = habits.filter((h) => !h.archived && isHabitDueOnDate(h, d, dateKey));
          const completedCount = (completions[dateKey] || []).filter((id) =>
            habits.some((h) => h.id === id && isHabitDueOnDate(h, d, dateKey))
          ).length;
          const totalDue = dueHabits.length;
          const value = totalDue === 0 ? 0 : completedCount / totalDue;
          result.push({
            label: `${d.getMonth() + 1}/${d.getDate()}`,
            fullDate: d.toLocaleDateString(),
            value,
          });
        }
        return result;
      }, [completions, habits]);

      return (
        <div className="h-full w-full overflow-x-auto pb-1 scrollbar-thin">
          <div className="flex items-end h-full gap-2 min-w-max px-1">
            {data.map((d, i) => (
              <div
                key={i}
                className="flex flex-col items-center w-6 flex-shrink-0 h-full justify-end group"
              >
                <div className="w-full h-full flex items-end relative bg-gray-50 dark:bg-dark-800 rounded-md overflow-hidden">
                  <div
                    className={`w-full rounded-b-md rounded-t-sm transition-all duration-500 ${
                      d.value >= 1
                        ? 'bg-emerald-500'
                        : d.value >= 0.8
                        ? 'bg-blue-400'
                        : d.value >= 0.5
                        ? 'bg-orange-400'
                        : d.value > 0
                        ? 'bg-gray-400'
                        : 'bg-transparent'
                    }`}
                    style={{ height: `${Math.min(d.value * 100, 100)}%` }}
                    title={`${d.fullDate}: ${Math.round(d.value * 100)}%`}
                  ></div>
                </div>
                <span className="text-[9px] text-gray-400 mt-1.5 font-medium whitespace-nowrap">
                  {d.label}
                </span>
              </div>
            ))}
          </div>
        </div>
      );
    };

    // =========================
    // FOCUS TIMER
    // =========================
    const FocusTimer = ({ habit, onClose, onComplete }) => {
      const [timeLeft, setTimeLeft] = useState(25 * 60);
      const [isActive, setIsActive] = useState(false);

      const formatTime = (seconds) => {
        const m = Math.floor(seconds / 60);
        const s = seconds % 60;
        return `${m}:${s < 10 ? '0' : ''}${s}`;
      };

      useEffect(() => {
        let interval = null;
        if (isActive && timeLeft > 0) {
          interval = setInterval(() => setTimeLeft((t) => t - 1), 1000);
        } else if (timeLeft === 0) {
          setIsActive(false);
          new Audio('https://actions.google.com/sounds/v1/alarms/beep_short.ogg')
            .play()
            .catch(() => {});
        }
        return () => clearInterval(interval);
      }, [isActive, timeLeft]);

      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center bg-dark-900 text-white modal-animate">
          <button
            onClick={onClose}
            className="absolute top-6 right-6 p-2 text-gray-400 hover:text-white"
          >
            <X size={32} />
          </button>
          <div className="flex flex-col items-center gap-8">
            <div className="text-xl font-medium text-indigo-400 flex items-center gap-2">
              <span className="text-3xl">{habit.icon}</span>
              {habit.name}
            </div>
            <div className="text-9xl font-bold font-mono tracking-tighter tabular-nums">
              {formatTime(timeLeft)}
            </div>
            <div className="flex gap-6">
              <button
                onClick={() => setIsActive(!isActive)}
                className={`w-20 h-20 rounded-full flex items-center justify-center transition-all ${
                  isActive ? 'bg-orange-500 hover:bg-orange-600' : 'bg-emerald-500 hover:bg-emerald-600'
                }`}
              >
                {isActive ? <Pause size={32} /> : <Play size={32} className="ml-1" />}
              </button>
            </div>
            {timeLeft === 0 && (
              <button
                onClick={onComplete}
                className="px-8 py-3 bg-white text-dark-900 font-bold rounded-full animate-bounce"
              >
                Complete Task
              </button>
            )}
          </div>
        </div>
      );
    };

    // =========================
    // SETTINGS MODAL
    // =========================
    const SettingsModal = ({
      isOpen,
      onClose,
      userId,
      onImport,
      onExport,
      vacationMode,
      setVacationMode,
      onRestore,
    }) => {
      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-xl w-full max-w-sm modal-animate overflow-hidden max-h-[90vh] overflow-y-auto">
            <div className="px-6 py-4 border-b border-gray-100 dark:border-dark-700 flex justify-between items-center">
              <h3 className="font-bold text-gray-800 dark:text-gray-100">Settings</h3>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X size={20} />
              </button>
            </div>

            <div className="p-6 space-y-6">
              {/* Vacation Mode */}
              <div className="flex items-center justify-between">
                <div>
                  <h4 className="text-sm font-bold dark:text-gray-200">Vacation Mode</h4>
                  <p className="text-[10px] text-gray-400">Pause streaks while away.</p>
                </div>
                <div
                  onClick={() => setVacationMode(!vacationMode)}
                  className={`w-10 h-5 rounded-full relative transition-colors cursor-pointer ${
                    vacationMode ? 'bg-indigo-500' : 'bg-gray-300 dark:bg-dark-600'
                  }`}
                >
                  <div
                    className={`absolute top-1 left-1 w-3 h-3 bg-white rounded-full transition-transform ${
                      vacationMode ? 'translate-x-5' : ''
                    }`}
                  ></div>
                </div>
              </div>

              {/* Data & Backup */}
              <div>
                <h4 className="text-xs font-bold text-gray-400 uppercase mb-3">
                  Data & Backup
                </h4>
                <div className="space-y-3">
                  <div className="p-3 bg-gray-50 dark:bg-dark-900 rounded-xl border border-gray-200 dark:border-dark-700">
                    <p className="text-[10px] text-gray-400 uppercase mb-1">Your ID</p>
                    <p className="font-mono text-xs text-gray-800 dark:text-gray-300 select-all">
                      {userId}
                    </p>
                  </div>

                  <div className="flex gap-2">
                    <button
                      onClick={onExport}
                      className="flex-1 py-2 bg-indigo-50 dark:bg-indigo-900/20 text-indigo-600 dark:text-indigo-400 rounded-lg text-xs font-bold flex items-center justify-center gap-2"
                    >
                      <Download size={14} /> Export JSON
                    </button>
                    <label className="flex-1 py-2 bg-gray-50 dark:bg-dark-700 text-gray-600 dark:text-gray-300 rounded-lg text-xs font-bold flex items-center justify-center gap-2 cursor-pointer">
                      <Upload size={14} /> Import
                      <input
                        type="file"
                        onChange={onImport}
                        className="hidden"
                        accept=".json"
                      />
                    </label>
                  </div>

                  <button
                    onClick={onRestore}
                    className="w-full py-2 text-xs text-gray-400 underline"
                  >
                    Restore from Backup ID (placeholder)
                  </button>
                </div>
              </div>

              {/* Archive Link (placeholder) */}
              <button className="w-full py-3 border border-gray-200 dark:border-dark-700 rounded-xl text-sm font-bold text-gray-600 dark:text-gray-400 flex items-center justify-center gap-2">
                <Archive size={16} /> View Archived Habits (not implemented)
              </button>
            </div>
          </div>
        </div>
      );
    };

    // =========================
    // HABIT MODAL
    // =========================
    const HabitModal = ({ isOpen, onClose, onSave, initialData, onDelete }) => {
      const [name, setName] = useState('');
      const [icon, setIcon] = useState(EMOJIS[0]);
      const [color, setColor] = useState(COLORS[0]);
      const [type, setType] = useState('habit');
      const [category, setCategory] = useState('General');
      const [difficulty, setDifficulty] = useState('easy');
      const [useTimer, setUseTimer] = useState(false);
      const [monthlyGoal, setMonthlyGoal] = useState('');
      const [time, setTime] = useState('');
      const [frequency, setFrequency] = useState([0, 1, 2, 3, 4, 5, 6]);
      const [targetDate, setTargetDate] = useState(formatDateKey(new Date()));

      useEffect(() => {
        if (isOpen) {
          if (initialData) {
            setName(initialData.name || '');
            setIcon(initialData.icon || EMOJIS[0]);
            setColor(initialData.color || COLORS[0]);
            setType(initialData.type || (initialData.isTask ? 'task' : 'habit'));
            setCategory(initialData.category || 'General');
            setDifficulty(initialData.difficulty || 'easy');
            setUseTimer(!!initialData.useTimer);
            setMonthlyGoal(
              typeof initialData.monthlyGoal === 'number'
                ? String(initialData.monthlyGoal)
                : ''
            );
            setTime(initialData.time || '');
            setFrequency(initialData.frequency || [0, 1, 2, 3, 4, 5, 6]);
            setTargetDate(initialData.targetDate || formatDateKey(new Date()));
          } else {
            setName('');
            setIcon(EMOJIS[0]);
            setColor(COLORS[11] || COLORS[0]);
            setType('habit');
            setCategory('General');
            setDifficulty('easy');
            setUseTimer(false);
            setMonthlyGoal('');
            setTime('');
            setFrequency([0, 1, 2, 3, 4, 5, 6]);
            setTargetDate(formatDateKey(new Date()));
          }
        }
      }, [isOpen, initialData]);

      const toggleDay = (dayIndex) => {
        if (frequency.includes(dayIndex)) {
          setFrequency(frequency.filter((d) => d !== dayIndex));
        } else {
          setFrequency([...frequency, dayIndex].sort());
        }
      };

      if (!isOpen) return null;

      return (
        <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
          <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-xl w-full max-w-sm modal-animate overflow-hidden max-h-[90vh] overflow-y-auto">
            <div className="px-6 py-4 border-b border-gray-100 dark:border-dark-700 flex justify-between items-center">
              <h3 className="font-bold text-gray-800 dark:text-gray-100">
                {initialData ? 'Edit Habit' : 'New Habit'}
              </h3>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X size={20} />
              </button>
            </div>

            <form
              onSubmit={(e) => {
                e.preventDefault();
                onSave({
                  id: initialData?.id,
                  name,
                  icon,
                  color,
                  type,
                  category,
                  difficulty,
                  useTimer,
                  monthlyGoal: parseInt(monthlyGoal || '0', 10) || 0,
                  time,
                  frequency,
                  targetDate,
                  archived: initialData?.archived || false,
                });
                onClose();
              }}
              className="p-6 space-y-5"
            >
              {/* Type Selector */}
              <div className="grid grid-cols-4 gap-1 bg-gray-100 dark:bg-dark-900 p-1 rounded-lg">
                {['habit', 'task', 'event', 'birthday'].map((t) => (
                  <button
                    key={t}
                    type="button"
                    onClick={() => setType(t)}
                    className={`py-2 rounded-md text-[10px] font-bold uppercase transition-all ${
                      type === t
                        ? 'bg-white dark:bg-dark-700 shadow text-indigo-600 dark:text-indigo-400'
                        : 'text-gray-400'
                    }`}
                  >
                    {t === 'habit' ? 'Routine' : t}
                  </button>
                ))}
              </div>

              {/* Name */}
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">
                  Name
                </label>
                <input
                  autoFocus
                  type="text"
                  value={name}
                  onChange={(e) => setName(e.target.value)}
                  className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm dark:text-white"
                  required
                />
              </div>

              {/* Icon */}
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-1">
                  Icon
                </label>
                <div className="flex gap-1 overflow-x-auto scrollbar-thin pb-1">
                  {EMOJIS.map((e) => (
                    <button
                      key={e}
                      type="button"
                      onClick={() => setIcon(e)}
                      className={`w-8 h-8 flex items-center justify-center rounded-lg text-lg ${
                        icon === e
                          ? 'bg-indigo-100 dark:bg-indigo-900/40'
                          : 'bg-gray-50 dark:bg-dark-900'
                      }`}
                    >
                      {e}
                    </button>
                  ))}
                </div>
              </div>

              {/* Category */}
              <div>
                <label className="block text-xs font-bold text-gray-400 uppercase mb-2">
                  Category
                </label>
                <div className="flex gap-2 overflow-x-auto pb-1 scrollbar-thin">
                  {CATEGORIES.slice(1).map((c) => (
                    <button
                      key={c}
                      type="button"
                      onClick={() => setCategory(c)}
                      className={`px-2 py-1.5 rounded-lg text-[10px] font-bold border whitespace-nowrap ${
                        category === c
                          ? 'bg-indigo-100 border-indigo-500 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400'
                          : 'border-gray-200 dark:border-dark-700 text-gray-500'
                      }`}
                    >
                      {c}
                    </button>
                  ))}
                </div>
              </div>

              {(type === 'habit' || type === 'task') && (
                <div className="space-y-4">
                  {/* Difficulty */}
                  <div className="flex gap-2">
                    {['easy', 'medium', 'hard'].map((d) => (
                      <button
                        key={d}
                        type="button"
                        onClick={() => setDifficulty(d)}
                        className={`flex-1 py-2 rounded-lg text-xs font-bold border capitalize transition-all ${
                          difficulty === d
                            ? d === 'hard'
                              ? 'bg-yellow-50 border-yellow-500 text-yellow-600 dark:bg-yellow-900/20 dark:text-yellow-400'
                              : 'bg-indigo-50 border-indigo-500 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400'
                            : 'border-gray-200 dark:border-dark-700 text-gray-400'
                        }`}
                      >
                        {d === 'hard' ? 'Heroic' : d}
                      </button>
                    ))}
                  </div>

                  {/* Monthly Goal + Timer */}
                  <div className="flex gap-3">
                    <div className="flex-1">
                      <label className="block text-xs font-bold text-gray-400 uppercase mb-1">
                        Monthly Goal
                      </label>
                      <input
                        type="number"
                        placeholder="Optional"
                        value={monthlyGoal}
                        onChange={(e) => setMonthlyGoal(e.target.value)}
                        className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white"
                      />
                    </div>
                    <div className="flex-1 flex items-end">
                      <div
                        onClick={() => setUseTimer(!useTimer)}
                        className={`w-full flex items-center justify-center p-3 rounded-xl border cursor-pointer transition-colors ${
                          useTimer
                            ? 'bg-indigo-50 border-indigo-500 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-400'
                            : 'bg-gray-50 border-gray-200 dark:bg-dark-900 text-gray-500'
                        }`}
                      >
                        <div className="flex items-center gap-2">
                          <Clock size={16} />
                          <span className="text-xs font-bold">Timer</span>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              )}

              {/* Time + Date */}
              <div className="flex gap-3">
                <div className="flex-1">
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-1">
                    Time
                  </label>
                  <input
                    type="time"
                    value={time}
                    onChange={(e) => setTime(e.target.value)}
                    className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white"
                  />
                </div>
                {type !== 'habit' && (
                  <div className="flex-1">
                    <label className="block text-xs font-bold text-gray-400 uppercase mb-1">
                      Date
                    </label>
                    <input
                      type="date"
                      value={targetDate}
                      onChange={(e) => setTargetDate(e.target.value)}
                      className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white"
                    />
                  </div>
                )}
              </div>

              {/* Frequency */}
              {type === 'habit' && (
                <div>
                  <label className="block text-xs font-bold text-gray-400 uppercase mb-2">
                    Frequency
                  </label>
                  <div className="flex justify-between">
                    {DAYS_OF_WEEK.map((d, i) => (
                      <button
                        key={i}
                        type="button"
                        onClick={() => toggleDay(i)}
                        className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${
                          frequency.includes(i)
                            ? 'bg-indigo-600 text-white shadow-md'
                            : 'bg-gray-100 dark:bg-dark-700 text-gray-400'
                        }`}
                      >
                        {d}
                      </button>
                    ))}
                  </div>
                </div>
              )}

              {/* Footer */}
              <div className="flex justify-between items-center pt-2">
                {initialData && (
                  <div className="flex gap-2">
                    <button
                      type="button"
                      onClick={() => {
                        onDelete(initialData.id);
                        onClose();
                      }}
                      className="p-3 text-red-500 bg-red-50 dark:bg-red-900/20 rounded-xl"
                    >
                      <Trash2 size={18} />
                    </button>
                    <button
                      type="button"
                      onClick={() => {
                        onSave({ ...initialData, archived: !initialData.archived });
                        onClose();
                      }}
                      className="p-3 text-gray-500 bg-gray-100 dark:bg-dark-700 rounded-xl"
                      title="Archive"
                    >
                      <Archive size={18} />
                    </button>
                  </div>
                )}
                <button
                  type="submit"
                  className="flex-1 ml-3 py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-md"
                >
                  Save
                </button>
              </div>
            </form>
          </div>
        </div>
      );
    };

    // =========================
    // NOTE MODAL
    // =========================
    const NoteModal = ({ isOpen, onClose, habit, notes, onSaveNote }) => {
      const [note, setNote] = useState('');

      useEffect(() => {
        if (isOpen && notes !== undefined) {
          setNote(notes || '');
        }
      }, [isOpen, notes]);

      if (!isOpen || !habit) return null;

      return (
        <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
          <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full max-w-sm modal-animate p-6">
            <div className="flex justify-between items-start mb-4">
              <div>
                <div className="text-3xl mb-1">{habit.icon}</div>
                <h2 className="text-xl font-bold dark:text-white">{habit.name}</h2>
              </div>
              <button onClick={onClose} className="text-gray-400 hover:text-gray-600">
                <X size={20} />
              </button>
            </div>

            <textarea
              placeholder="Add details..."
              value={note}
              onChange={(e) => setNote(e.target.value)}
              className="w-full h-32 p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm dark:text-gray-200 mb-4"
            />

            <div className="flex gap-3">
              <button onClick={onClose} className="flex-1 py-3 text-gray-500 font-bold">
                Cancel
              </button>
              <button
                onClick={() => {
                  onSaveNote(habit.id, note);
                  onClose();
                }}
                className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg"
              >
                Save
              </button>
            </div>
          </div>
        </div>
      );
    };

    // =========================
    // MAIN APP
    // =========================
    const App = () => {
      const [userId, setUserId] = useState(
        () => localStorage.getItem('habit_user_id') || `user_${Math.random().toString(36).substr(2, 9)}`
      );
      const [habits, setHabits] = useState(() => {
        try {
          const raw = localStorage.getItem('habit_habits');
          return raw ? JSON.parse(raw) : [];
        } catch {
          return [];
        }
      });
      const [completions, setCompletions] = useState(() => {
        try {
          const raw = localStorage.getItem('habit_completions');
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      });
      const [dailyNotes, setDailyNotes] = useState(() => {
        try {
          const raw = localStorage.getItem('habit_daily_notes');
          return raw ? JSON.parse(raw) : {};
        } catch {
          return {};
        }
      });
      const [vacationMode, setVacationMode] = useState(() => {
        return localStorage.getItem('habit_vacation_mode') === 'true';
      });
      const [darkMode, setDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
      const [status, setStatus] = useState('offline'); // placeholder for Supabase sync status
      const [currentDate, setCurrentDate] = useState(new Date());
      const [selectedDate, setSelectedDate] = useState(new Date());
      const [isModalOpen, setIsModalOpen] = useState(false);
      const [isSettingsOpen, setIsSettingsOpen] = useState(false);
      const [editingHabit, setEditingHabit] = useState(null);
      const [detailHabit, setDetailHabit] = useState(null);
      const [isReorderMode, setIsReorderMode] = useState(false);
      const [chartMode, setChartMode] = useState('heatmap');
      const [selectedCategory, setSelectedCategory] = useState('All');
      const [activeFocusHabit, setActiveFocusHabit] = useState(null);
      const [noteModalHabit, setNoteModalHabit] = useState(null);

      // Persist userId
      useEffect(() => {
        localStorage.setItem('habit_user_id', userId);
      }, [userId]);

      // Dark mode
      useEffect(() => {
        if (darkMode) {
          document.documentElement.classList.add('dark');
          localStorage.setItem('theme', 'dark');
        } else {
          document.documentElement.classList.remove('dark');
          localStorage.setItem('theme', 'light');
        }
      }, [darkMode]);

      // Persist habits/completions/notes/vacation
      useEffect(() => {
        localStorage.setItem('habit_habits', JSON.stringify(habits));
      }, [habits]);

      useEffect(() => {
        localStorage.setItem('habit_completions', JSON.stringify(completions));
      }, [completions]);

      useEffect(() => {
        localStorage.setItem('habit_daily_notes', JSON.stringify(dailyNotes));
      }, [dailyNotes]);

      useEffect(() => {
        localStorage.setItem('habit_vacation_mode', vacationMode ? 'true' : 'false');
      }, [vacationMode]);

      // =========================
      // SUPABASE SYNC PLACEHOLDERS
      // =========================
      // TODO: Replace these placeholders with real Supabase calls.
      // Example structure is shown; you can wire it to your tables.

      const loadFromSupabase = async () => {
        try {
          setStatus('syncing');

          // TODO: FETCH HABITS
          // const { data: habitsData, error: habitsError } = await supabase
          //   .from('habits')
          //   .select('*')
          //   .eq('user_id', userId);
          //
          // TODO: FETCH COMPLETIONS
          // const { data: completionsData, error: completionsError } = await supabase
          //   .from('completions')
          //   .select('*')
          //   .eq('user_id', userId);
          //
          // TODO: FETCH NOTES
          // const { data: notesData, error: notesError } = await supabase
          //   .from('notes')
          //   .select('*')
          //   .eq('user_id', userId);

          // For now, just mark as offline/local
          setStatus('offline');
        } catch (e) {
          console.error(e);
          setStatus('offline');
        }
      };

      const saveHabitToSupabase = async (habit) => {
        // TODO: UPSERT habit to Supabase
        // await supabase.from('habits').upsert({ ...habit, user_id: userId });
      };

      const deleteHabitFromSupabase = async (habitId) => {
        // TODO: DELETE habit from Supabase
        // await supabase.from('habits').delete().eq('id', habitId).eq('user_id', userId);
      };

      const saveCompletionToSupabase = async (dateKey, habitId, completed) => {
        // TODO: Insert or delete completion row in Supabase
      };

      const saveNoteToSupabase = async (dateKey, habitId, note) => {
        // TODO: Upsert note row in Supabase
      };

      useEffect(() => {
        loadFromSupabase();
      }, [userId]);

      // =========================
      // HANDLERS
      // =========================
      const handleToggleCompletion = (habitId, dateKey) => {
        setCompletions((prev) => {
          const dayList = prev[dateKey] || [];
          const exists = dayList.includes(habitId);
          const newDayList = exists ? dayList.filter((id) => id !== habitId) : [...dayList, habitId];
          const updated = { ...prev, [dateKey]: newDayList };
          saveCompletionToSupabase(dateKey, habitId, !exists);
          return updated;
        });

        if (!completions[dateKey] || !completions[dateKey].includes(habitId)) {
          // Confetti on completion
          confetti({
            particleCount: 60,
            spread: 60,
            origin: { y: 0.7 },
          });
        }
      };

      const handleSaveHabit = (habitData) => {
        setHabits((prev) => {
          if (habitData.id) {
            const updated = prev.map((h) => (h.id === habitData.id ? { ...h, ...habitData } : h));
            saveHabitToSupabase(habitData);
            return updated;
          } else {
            const newHabit = {
              ...habitData,
              id: `habit_${Date.now()}_${Math.random().toString(36).slice(2, 7)}`,
              createdAt: new Date().toISOString(),
            };
            saveHabitToSupabase(newHabit);
            return [...prev, newHabit];
          }
        });
      };

      const handleDeleteHabit = (habitId) => {
        setHabits((prev) => prev.filter((h) => h.id !== habitId));
        deleteHabitFromSupabase(habitId);
      };

      const handleSaveNote = (habitId, note) => {
        const dateKey = formatDateKey(selectedDate);
        setDailyNotes((prev) => {
          const dayNotes = prev[dateKey] || {};
          const updated = {
            ...prev,
            [dateKey]: {
              ...dayNotes,
              [habitId]: note,
            },
          };
          saveNoteToSupabase(dateKey, habitId, note);
          return updated;
        });
      };

      const handleExport = () => {
        const data = {
          userId,
          habits,
          completions,
          dailyNotes,
          vacationMode,
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `habit-os-backup-${userId}.json`;
        a.click();
        URL.revokeObjectURL(url);
      };

      const handleImport = (e) => {
        const file = e.target.files?.[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (ev) => {
          try {
            const data = JSON.parse(ev.target.result);
            if (data.habits && data.completions) {
              setHabits(data.habits);
              setCompletions(data.completions);
              setDailyNotes(data.dailyNotes || {});
              setVacationMode(!!data.vacationMode);
              if (data.userId) setUserId(data.userId);
            }
          } catch (err) {
            console.error('Import error', err);
          }
        };
        reader.readAsText(file);
      };

      const handleRestoreFromBackupId = () => {
        // Placeholder: you could implement a Supabase-based backup retrieval by backup ID
        alert('Restore from Backup ID is not implemented yet.');
      };

      const goToToday = () => {
        const today = new Date();
        setCurrentDate(today);
        setSelectedDate(today);
      };

      const changeDay = (delta) => {
        setSelectedDate((prev) => {
          const d = new Date(prev);
          d.setDate(d.getDate() + delta);
          return d;
        });
      };

      const filteredHabits = useMemo(() => {
        return habits.filter((h) => {
          if (h.archived) return false;
          if (selectedCategory !== 'All' && h.category !== selectedCategory) return false;
          return true;
        });
      }, [habits, selectedCategory]);

      const dateKey = formatDateKey(selectedDate);

      const dueHabitsToday = filteredHabits.filter((h) => isHabitDueOnDate(h, selectedDate, dateKey));
      const completedToday = (completions[dateKey] || []).filter((id) =>
        dueHabitsToday.some((h) => h.id === id)
      );
      const completionRatio =
        dueHabitsToday.length === 0 ? 0 : completedToday.length / dueHabitsToday.length;

      return (
        <div className="min-h-screen flex flex-col items-center py-6 px-3 sm:px-6">
          <div className="w-full max-w-5xl glass rounded-3xl shadow-xl border border-gray-200/60 dark:border-dark-700/80 p-4 sm:p-6 md:p-8">
            {/* Header */}
            <div className="flex items-center justify-between mb-6">
              <div className="flex items-center gap-3">
                <div className="w-10 h-10 rounded-2xl bg-indigo-600 flex items-center justify-center text-white font-bold text-xl">
                  H
                </div>
                <div>
                  <div className="flex items-center gap-2">
                    <h1 className="text-lg sm:text-xl font-bold tracking-tight">
                      Habit OS Stable Pro
                    </h1>
                    <span className="inline-flex items-center gap-1 px-2 py-0.5 rounded-full text-[10px] font-semibold bg-emerald-50 text-emerald-600 dark:bg-emerald-900/20 dark:text-emerald-300">
                      <Cloud size={12} />
                      {status === 'syncing' ? 'Syncing...' : 'Local'}
                    </span>
                  </div>
                  <p className="text-xs text-gray-500 dark:text-gray-400">
                    Systems-level habit tracker with streaks, charts, and focus.
                  </p>
                </div>
              </div>

              <div className="flex items-center gap-2">
                <button
                  onClick={() => setDarkMode((d) => !d)}
                  className="p-2 rounded-xl bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                >
                  {darkMode ? <Sun size={18} /> : <Moon size={18} />}
                </button>
                <button
                  onClick={() => setIsSettingsOpen(true)}
                  className="p-2 rounded-xl bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                >
                  <Settings size={18} />
                </button>
              </div>
            </div>

            {/* Date + Progress */}
            <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4 mb-6">
              <div className="flex items-center gap-3">
                <button
                  onClick={() => changeDay(-1)}
                  className="p-2 rounded-xl bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                >
                  <ChevronLeft size={18} />
                </button>
                <div className="text-center">
                  <div className="text-xs uppercase tracking-wide text-gray-400">
                    {selectedDate.toLocaleDateString(undefined, {
                      weekday: 'short',
                      month: 'short',
                      day: 'numeric',
                    })}
                  </div>
                  <div className="text-sm text-gray-500">
                    {isSameDayMonth(selectedDate, new Date()) ? 'Today' : ''}
                  </div>
                </div>
                <button
                  onClick={() => changeDay(1)}
                  className="p-2 rounded-xl bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                >
                  <ChevronRight size={18} />
                </button>
                <button
                  onClick={goToToday}
                  className="ml-2 px-3 py-1.5 rounded-xl text-xs font-semibold bg-indigo-50 text-indigo-600 dark:bg-indigo-900/20 dark:text-indigo-300"
                >
                  Today
                </button>
              </div>

              <div className="flex-1 flex flex-col md:items-end gap-2">
                <div className="flex items-center gap-2 text-xs text-gray-500">
                  <Fire size={16} className="text-orange-500" />
                  <span>
                    {completedToday.length}/{dueHabitsToday.length} today
                  </span>
                  <span className="text-gray-300">â€¢</span>
                  <span>{Math.round(completionRatio * 100)}% completion</span>
                </div>
                <MiniProgressBar
                  value={completedToday.length}
                  max={dueHabitsToday.length || 1}
                  colorClass="bg-indigo-500"
                />
              </div>
            </div>

            {/* Category + Controls */}
            <div className="flex flex-wrap items-center justify-between gap-3 mb-4">
              <div className="flex gap-2 overflow-x-auto scrollbar-thin">
                {CATEGORIES.map((c) => (
                  <button
                    key={c}
                    onClick={() => setSelectedCategory(c)}
                    className={`px-3 py-1.5 rounded-full text-xs font-semibold border whitespace-nowrap ${
                      selectedCategory === c
                        ? 'bg-indigo-600 text-white border-indigo-600'
                        : 'bg-gray-50 dark:bg-dark-800 border-gray-200 dark:border-dark-700 text-gray-600 dark:text-gray-300'
                    }`}
                  >
                    {c}
                  </button>
                ))}
              </div>

              <div className="flex items-center gap-2">
                <button
                  onClick={() => setIsReorderMode((m) => !m)}
                  className={`px-3 py-1.5 rounded-xl text-xs font-semibold flex items-center gap-1 border ${
                    isReorderMode
                      ? 'bg-amber-50 border-amber-400 text-amber-700 dark:bg-amber-900/20 dark:text-amber-300'
                      : 'bg-gray-50 dark:bg-dark-800 border-gray-200 dark:border-dark-700 text-gray-600 dark:text-gray-300'
                  }`}
                >
                  <Sort size={14} />
                  {isReorderMode ? 'Reorder On' : 'Reorder'}
                </button>
                <button
                  onClick={() => {
                    setEditingHabit(null);
                    setIsModalOpen(true);
                  }}
                  className="px-3 py-1.5 rounded-xl text-xs font-semibold bg-indigo-600 text-white flex items-center gap-1 shadow-sm"
                >
                  <Plus size={14} />
                  New
                </button>
              </div>
            </div>

            {/* Habits List */}
            <div className="space-y-3 mb-6">
              {dueHabitsToday.length === 0 && (
                <div className="text-xs text-gray-400 text-center py-6 border border-dashed border-gray-200 dark:border-dark-700 rounded-2xl">
                  No habits due for this day. Create or adjust frequencies.
                </div>
              )}

              {dueHabitsToday.map((habit) => {
                const color = habit.color || COLORS[0];
                const streak = calculateStreak(habit.id, completions, vacationMode);
                const isCompleted = (completions[dateKey] || []).includes(habit.id);
                const notesForDay = dailyNotes[dateKey]?.[habit.id] || '';

                return (
                  <div
                    key={habit.id}
                    className={`flex items-center gap-3 p-3 rounded-2xl border bg-white dark:bg-dark-800 border-gray-200 dark:border-dark-700`}
                  >
                    <button
                      onClick={() => handleToggleCompletion(habit.id, dateKey)}
                      className={`w-8 h-8 rounded-full flex items-center justify-center border ${
                        isCompleted
                          ? 'bg-emerald-500 border-emerald-500 text-white'
                          : 'bg-gray-50 dark:bg-dark-900 border-gray-200 dark:border-dark-700 text-gray-400'
                      }`}
                    >
                      {isCompleted ? <Check size={18} /> : null}
                    </button>

                    <div className="flex-1 min-w-0">
                      <div className="flex items-center justify-between gap-2">
                        <div className="flex items-center gap-2 min-w-0">
                          <span className="text-xl">{habit.icon}</span>
                          <div className="min-w-0">
                            <div className="flex items-center gap-2">
                              <p className="text-sm font-semibold truncate">{habit.name}</p>
                              {habit.type === 'task' && (
                                <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-blue-50 text-blue-600 dark:bg-blue-900/20 dark:text-blue-300">
                                  Task
                                </span>
                              )}
                              {habit.type === 'event' && (
                                <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-purple-50 text-purple-600 dark:bg-purple-900/20 dark:text-purple-300">
                                  Event
                                </span>
                              )}
                              {habit.type === 'birthday' && (
                                <span className="text-[10px] px-1.5 py-0.5 rounded-full bg-pink-50 text-pink-600 dark:bg-pink-900/20 dark:text-pink-300">
                                  Birthday
                                </span>
                              )}
                            </div>
                            <div className="flex items-center gap-2 text-[11px] text-gray-400 mt-0.5">
                              {habit.time && (
                                <span className="inline-flex items-center gap-1">
                                  <Clock size={12} />
                                  {habit.time}
                                </span>
                              )}
                              <span className="inline-flex items-center gap-1">
                                <Fire size={12} className="text-orange-500" />
                                {streak} day{streak === 1 ? '' : 's'}
                              </span>
                              {habit.monthlyGoal > 0 && (
                                <span className="inline-flex items-center gap-1">
                                  <Trophy size={12} className="text-yellow-500" />
                                  {habit.monthlyGoal}/month
                                </span>
                              )}
                            </div>
                          </div>
                        </div>

                        <div className="flex items-center gap-1">
                          {habit.useTimer && (
                            <button
                              onClick={() => setActiveFocusHabit(habit)}
                              className="p-1.5 rounded-lg bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                              title="Focus Timer"
                            >
                              <Play size={14} />
                            </button>
                          )}
                          <button
                            onClick={() => {
                              setEditingHabit(habit);
                              setIsModalOpen(true);
                            }}
                            className="p-1.5 rounded-lg bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                          >
                            <Edit2 size={14} />
                          </button>
                          <button
                            onClick={() => setNoteModalHabit(habit)}
                            className="p-1.5 rounded-lg bg-gray-100 dark:bg-dark-700 text-gray-600 dark:text-gray-300"
                            title="Notes"
                          >
                            ðŸ“
                          </button>
                        </div>
                      </div>

                      {notesForDay && (
                        <p className="mt-1 text-[11px] text-gray-500 line-clamp-2">
                          {notesForDay}
                        </p>
                      )}
                    </div>
                  </div>
                );
              })}
            </div>

            {/* Charts */}
            <div className="border-t border-gray-200 dark:border-dark-700 pt-4">
              <div className="flex items-center justify-between mb-3">
                <div className="flex items-center gap-2 text-xs text-gray-500">
                  <BarChart2 size={16} />
                  <span>Consistency</span>
                </div>
                <div className="flex gap-1 text-[10px]">
                  <button
                    onClick={() => setChartMode('heatmap')}
                    className={`px-2 py-1 rounded-lg flex items-center gap-1 ${
                      chartMode === 'heatmap'
                        ? 'bg-indigo-600 text-white'
                        : 'bg-gray-100 dark:bg-dark-700 text-gray-500'
                    }`}
                  >
                    <Grid size={12} />
                    Year
                  </button>
                  <button
                    onClick={() => setChartMode('bars')}
                    className={`px-2 py-1 rounded-lg flex items-center gap-1 ${
                      chartMode === 'bars'
                        ? 'bg-indigo-600 text-white'
                        : 'bg-gray-100 dark:bg-dark-700 text-gray-500'
                    }`}
                  >
                    <BarChart2 size={12} />
                    30 days
                  </button>
                </div>
              </div>

              <div className="h-32 sm:h-40 border border-gray-200 dark:border-dark-700 rounded-2xl bg-gray-50 dark:bg-dark-900 flex items-center justify-center">
                {chartMode === 'heatmap' ? (
                  <YearHeatmap completions={completions} habits={habits} />
                ) : (
                  <ConsistencyChart completions={completions} habits={habits} />
                )}
              </div>
            </div>
          </div>

          {/* Modals */}
          <HabitModal
            isOpen={isModalOpen}
            onClose={() => setIsModalOpen(false)}
            onSave={handleSaveHabit}
            initialData={editingHabit}
            onDelete={handleDeleteHabit}
          />

          <SettingsModal
            isOpen={isSettingsOpen}
            onClose={() => setIsSettingsOpen(false)}
            userId={userId}
            onImport={handleImport}
            onExport={handleExport}
            vacationMode={vacationMode}
            setVacationMode={setVacationMode}
            onRestore={handleRestoreFromBackupId}
          />

          <NoteModal
            isOpen={!!noteModalHabit}
            onClose={() => setNoteModalHabit(null)}
            habit={noteModalHabit}
            notes={
              noteModalHabit
                ? dailyNotes[formatDateKey(selectedDate)]?.[noteModalHabit.id] || ''
                : ''
            }
            onSaveNote={handleSaveNote}
          />

          {activeFocusHabit && (
            <FocusTimer
              habit={activeFocusHabit}
              onClose={() => setActiveFocusHabit(null)}
              onComplete={() => {
                handleToggleCompletion(activeFocusHabit.id, formatDateKey(selectedDate));
                setActiveFocusHabit(null);
              }}
            />
          )}
        </div>
      );
    };

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
