<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Habit OS Ultimate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: { 900: '#0f172a', 800: '#1e293b', 700: '#334155', 200: '#e2e8f0' }
                    }
                }
            }
        }
    </script>
    <style>
        .scrollbar-thin::-webkit-scrollbar { width: 6px; height: 6px; }
        .scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
        .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        .dark .scrollbar-thin::-webkit-scrollbar-thumb { background-color: #475569; }
        .modal-animate { animation: fadeIn 0.2s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        /* Prevent text selection during long press */
        .no-select { -webkit-touch-callout: none; -webkit-user-select: none; user-select: none; }
    </style>
</head>
<body class="bg-gray-50 text-gray-900 dark:bg-dark-900 dark:text-dark-200 transition-colors duration-300">
    <div id="root"></div>

    <script type="text/babel">
        // ==========================================
        // ‚ö†Ô∏è PASTE YOUR SUPABASE KEYS HERE
        // ==========================================
        const SUPABASE_URL = 'https://ncfgnaqfmuohblaedaka.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5jZmduYXFmbXVvaGJsYWVkYWthIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzAwNTI3MjksImV4cCI6MjA4NTYyODcyOX0.ygUbFJ9z7GQ3HG4SfOviMjMFc11TM0UQDoGuGGNk9lI'; 
        // ==========================================

        const { useState, useEffect, useMemo, useRef } = React;
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        // --- ICONS & CONSTANTS ---
        const Icon = ({ children, size=20, className="" }) => <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}>{children}</svg>;
        const ChevronLeft = p => <Icon {...p}><path d="m15 18-6-6 6-6"/></Icon>;
        const ChevronRight = p => <Icon {...p}><path d="m9 18 6-6 6-6"/></Icon>;
        const Check = p => <Icon {...p}><polyline points="20 6 9 17 4 12"/></Icon>;
        const Plus = p => <Icon {...p}><path d="M5 12h14"/><path d="M12 5v14"/></Icon>;
        const Trash2 = p => <Icon {...p}><path d="M3 6h18"/><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6"/><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2"/><line x1="10" x2="10" y1="11" y2="17"/><line x1="14" x2="14" y1="11" y2="17"/></Icon>;
        const Trophy = p => <Icon {...p}><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6"/><path d="M18 9h1.5a2.5 2.5 0 0 0 0-5H18"/><path d="M4 22h16"/><path d="M10 14.66V17c0 .55-.47.98-.97 1.21C7.85 18.75 7 20.24 7 22"/><path d="M14 14.66V17c0 .55.47.98.97 1.21C16.15 18.75 17 20.24 17 22"/><path d="M18 2H6v7a6 6 0 0 0 12 0V2Z"/></Icon>;
        const Edit2 = p => <Icon {...p}><path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></Icon>;
        const X = p => <Icon {...p}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></Icon>;
        const Cloud = p => <Icon {...p}><path d="M17.5 19c0-3.037-2.463-5.5-5.5-5.5S6.5 15.963 6.5 19"/><path d="M12 13.5V4"/><path d="m16 8-4-4-4 4"/></Icon>;
        const Moon = p => <Icon {...p}><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></Icon>;
        const Sun = p => <Icon {...p}><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d="m19.07 4.93-1.41 1.41"/></Icon>;
        const Clock = p => <Icon {...p}><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></Icon>;
        const Fire = p => <Icon {...p}><path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.1.2-2.2.5-3.3.3-1.4 1.8-2.7 3-3.2v-.5c0 1.5 0 2.5 0 2.5z"/></Icon>;

        const COLORS = [
            { name: 'Orange', bg: 'bg-orange-100', text: 'text-orange-600', bar: 'bg-orange-500', dot: 'bg-orange-500', darkBg: 'dark:bg-orange-900/30', darkText: 'dark:text-orange-400' },
            { name: 'Emerald', bg: 'bg-emerald-100', text: 'text-emerald-600', bar: 'bg-emerald-500', dot: 'bg-emerald-500', darkBg: 'dark:bg-emerald-900/30', darkText: 'dark:text-emerald-400' },
            { name: 'Blue', bg: 'bg-blue-100', text: 'text-blue-600', bar: 'bg-blue-500', dot: 'bg-blue-500', darkBg: 'dark:bg-blue-900/30', darkText: 'dark:text-blue-400' },
            { name: 'Purple', bg: 'bg-purple-100', text: 'text-purple-600', bar: 'bg-purple-500', dot: 'bg-purple-500', darkBg: 'dark:bg-purple-900/30', darkText: 'dark:text-purple-400' },
            { name: 'Rose', bg: 'bg-rose-100', text: 'text-rose-600', bar: 'bg-rose-500', dot: 'bg-rose-500', darkBg: 'dark:bg-rose-900/30', darkText: 'dark:text-rose-400' },
        ];
        
        // Extended Emoji List
        const EMOJIS = ["‚úçÔ∏è", "üí™", "üìö", "üíß", "üßò", "üèÉ", "üôè", "üì±", "ü•¶", "üíä", "üí∞", "üß†", "üö≠", "üé®", "üé∏", "üßπ", "ü¶∑", "üê∂", "üåø", "‚è∞", "üí§", "üåû", "üéì", "üíº", "üõí"];
        
        const DAYS_OF_WEEK = ['S', 'M', 'T', 'W', 'T', 'F', 'S'];

        // --- HELPERS ---
        const formatDateKey = (date) => `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}-${String(date.getDate()).padStart(2, '0')}`;
        
        const calculateStreak = (habitId, completions) => {
            let streak = 0;
            const today = new Date();
            // Check up to 365 days back
            for (let i = 0; i < 365; i++) {
                const d = new Date();
                d.setDate(today.getDate() - i);
                const k = formatDateKey(d);
                if (completions[k]?.includes(habitId)) {
                    streak++;
                } else if (i === 0) {
                    // If today is missing, don't break streak yet (unless we check yesterday)
                    continue; 
                } else {
                    break;
                }
            }
            return streak;
        };

        // --- COMPONENTS ---

        const MiniProgressBar = ({ percentage, colorClass }) => (
            <div className="w-full bg-gray-100 dark:bg-dark-700 rounded-full h-1.5 mt-3 overflow-hidden">
                <div className={`h-1.5 rounded-full transition-all duration-500 ease-out ${colorClass}`} style={{ width: `${percentage}%` }}></div>
            </div>
        );

        const ConsistencyChart = ({ completions, habits }) => {
            const data = useMemo(() => {
                if (habits.length === 0) return [];
                const days = 30;
                const result = [];
                const today = new Date();
                for (let i = days - 1; i >= 0; i--) {
                    const d = new Date();
                    d.setDate(today.getDate() - i);
                    const dateKey = formatDateKey(d);
                    // Filter habits that were actually due on that day
                    const dueHabits = habits.filter(h => {
                         if (h.isTask && h.targetDate !== dateKey) return false;
                         if (!h.isTask && h.frequency && !h.frequency.includes(d.getDay())) return false;
                         return true;
                    });
                    
                    const completedCount = (completions[dateKey] || []).filter(id => habits.some(h => h.id === id)).length;
                    const totalDue = dueHabits.length || 1; // prevent divide by zero
                    const percentage = Math.min(completedCount / totalDue, 1);
                    result.push({ label: `${d.getMonth() + 1}/${d.getDate()}`, fullDate: d.toLocaleDateString(), value: percentage });
                }
                return result;
            }, [completions, habits]);

            return (
                <div className="h-full w-full overflow-x-auto pb-1 scrollbar-thin">
                    <div className="flex items-end h-full gap-2 min-w-max px-1">
                        {data.map((d, i) => (
                            <div key={i} className="flex flex-col items-center w-6 flex-shrink-0 h-full justify-end group">
                                <div className="w-full h-full flex items-end relative bg-gray-50 dark:bg-dark-800 rounded-md overflow-hidden">
                                    <div className={`w-full rounded-b-md rounded-t-sm transition-all duration-500 ${d.value === 1 ? 'bg-emerald-400' : d.value > 0 ? 'bg-indigo-400' : 'bg-transparent'}`} style={{ height: `${Math.max(d.value * 100, 0)}%` }}></div>
                                </div>
                                <span className="text-[9px] text-gray-400 mt-1.5 font-medium whitespace-nowrap">{d.label}</span>
                            </div>
                        ))}
                    </div>
                </div>
            );
        };

        const HabitModal = ({ isOpen, onClose, onSave, initialData, onDelete }) => {
            const [name, setName] = useState('');
            const [icon, setIcon] = useState(EMOJIS[0]);
            const [color, setColor] = useState(COLORS[0]);
            const [isTask, setIsTask] = useState(false);
            const [time, setTime] = useState('');
            const [frequency, setFrequency] = useState([0,1,2,3,4,5,6]); // All days by default
            const [targetDate, setTargetDate] = useState(formatDateKey(new Date()));

            useEffect(() => {
                if (isOpen) {
                    if (initialData) {
                        setName(initialData.name);
                        setIcon(initialData.icon);
                        setColor(initialData.color);
                        setIsTask(!!initialData.isTask);
                        setTime(initialData.time || '');
                        setFrequency(initialData.frequency || [0,1,2,3,4,5,6]);
                        setTargetDate(initialData.targetDate || formatDateKey(new Date()));
                    } else {
                        setName(''); setIcon(EMOJIS[0]); setColor(COLORS[3]); setIsTask(false); setTime(''); setFrequency([0,1,2,3,4,5,6]);
                    }
                }
            }, [isOpen, initialData]);

            const toggleDay = (dayIndex) => {
                if (frequency.includes(dayIndex)) setFrequency(frequency.filter(d => d !== dayIndex));
                else setFrequency([...frequency, dayIndex].sort());
            };

            if (!isOpen) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/50 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-xl w-full max-w-sm modal-animate overflow-hidden max-h-[90vh] overflow-y-auto">
                        <div className="px-6 py-4 border-b border-gray-100 dark:border-dark-700 flex justify-between items-center">
                            <h3 className="font-bold text-gray-800 dark:text-gray-100">{initialData ? 'Edit' : 'New'}</h3>
                            <button onClick={onClose} className="text-gray-400 hover:text-gray-600"><X size={20} /></button>
                        </div>
                        <form onSubmit={(e) => { e.preventDefault(); onSave({ id: initialData?.id, name, icon, color, isTask, time, frequency, targetDate }); onClose(); }} className="p-6 space-y-5">
                            {/* Type Selector */}
                            <div className="flex bg-gray-100 dark:bg-dark-900 p-1 rounded-lg">
                                <button type="button" onClick={() => setIsTask(false)} className={`flex-1 py-2 rounded-md text-xs font-bold transition-all ${!isTask ? 'bg-white dark:bg-dark-700 shadow text-indigo-600 dark:text-indigo-400' : 'text-gray-500'}`}>Routine Habit</button>
                                <button type="button" onClick={() => setIsTask(true)} className={`flex-1 py-2 rounded-md text-xs font-bold transition-all ${isTask ? 'bg-white dark:bg-dark-700 shadow text-indigo-600 dark:text-indigo-400' : 'text-gray-500'}`}>One-Off Task</button>
                            </div>

                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Name</label><input autoFocus type="text" value={name} onChange={e => setName(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm dark:text-white" placeholder="e.g. Gym" /></div>
                            
                            {/* Time & Date */}
                            <div className="flex gap-3">
                                <div className="flex-1"><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Time (Opt)</label><input type="time" value={time} onChange={e => setTime(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white" /></div>
                                {isTask && <div className="flex-1"><label className="block text-xs font-bold text-gray-400 uppercase mb-1">Date</label><input type="date" value={targetDate} onChange={e => setTargetDate(e.target.value)} className="w-full p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl focus:outline-none text-sm dark:text-white" /></div>}
                            </div>

                            {/* Frequency (Only for Habits) */}
                            {!isTask && (
                                <div>
                                    <label className="block text-xs font-bold text-gray-400 uppercase mb-2">Frequency</label>
                                    <div className="flex justify-between">
                                        {DAYS_OF_WEEK.map((d, i) => (
                                            <button key={i} type="button" onClick={() => toggleDay(i)} className={`w-8 h-8 rounded-full text-xs font-bold transition-all ${frequency.includes(i) ? 'bg-indigo-600 text-white shadow-md' : 'bg-gray-100 dark:bg-dark-700 text-gray-400'}`}>{d}</button>
                                        ))}
                                    </div>
                                </div>
                            )}

                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Icon</label><div className="flex gap-2 overflow-x-auto pb-2 scrollbar-thin">{EMOJIS.map(e => <button key={e} type="button" onClick={() => setIcon(e)} className={`flex-shrink-0 w-10 h-10 flex items-center justify-center text-xl rounded-lg ${icon === e ? 'bg-indigo-100 dark:bg-dark-700 border-2 border-indigo-500' : 'bg-gray-50 dark:bg-dark-900 dark:text-white'}`}>{e}</button>)}</div></div>
                            <div><label className="block text-xs font-bold text-gray-400 uppercase mb-2">Color</label><div className="flex flex-wrap gap-3">{COLORS.map(c => <button key={c.name} type="button" onClick={() => setColor(c)} className={`w-8 h-8 rounded-full ${c.dot} ${color.name === c.name ? 'ring-2 ring-offset-2 ring-gray-400' : ''}`} />)}</div></div>
                            
                            <div className="flex gap-3 pt-2">
                                {initialData && <button type="button" onClick={() => { onDelete(initialData.id); onClose(); }} className="flex-1 py-3 text-red-600 bg-red-50 dark:bg-red-900/20 rounded-xl text-sm font-bold">Delete</button>}
                                <button type="submit" className="flex-[2] py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-md">Save</button>
                            </div>
                        </form>
                    </div>
                </div>
            );
        };

        const NoteModal = ({ isOpen, onClose, habit, streak, notes, onSaveNote }) => {
            const [note, setNote] = useState('');
            useEffect(() => { if (isOpen && notes) setNote(notes || ''); }, [isOpen, notes]);
            if (!isOpen || !habit) return null;

            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm">
                    <div className="bg-white dark:bg-dark-800 rounded-2xl shadow-2xl w-full max-w-sm modal-animate p-6">
                        <div className="flex justify-between items-start mb-4">
                            <div><div className="text-3xl mb-1">{habit.icon}</div><h2 className="text-xl font-bold dark:text-white">{habit.name}</h2></div>
                            <div className="flex flex-col items-end"><div className="flex items-center gap-1 text-orange-500 font-bold bg-orange-50 dark:bg-orange-900/20 px-2 py-1 rounded-lg"><Fire size={14} /> <span>{streak} Day Streak</span></div></div>
                        </div>
                        <textarea placeholder="Add a note for today..." value={note} onChange={e => setNote(e.target.value)} className="w-full h-32 p-3 bg-gray-50 dark:bg-dark-900 border border-gray-200 dark:border-dark-700 rounded-xl resize-none focus:outline-none focus:ring-2 focus:ring-indigo-500 text-sm dark:text-gray-200 mb-4" />
                        <div className="flex gap-3">
                            <button onClick={onClose} className="flex-1 py-3 text-gray-500 font-bold">Cancel</button>
                            <button onClick={() => { onSaveNote(habit.id, note); onClose(); }} className="flex-1 py-3 bg-indigo-600 text-white rounded-xl font-bold shadow-lg">Save Note</button>
                        </div>
                    </div>
                </div>
            );
        };

        const App = () => {
            const [userId, setUserId] = useState(() => localStorage.getItem('habit_user_id') || `user_${Math.random().toString(36).substr(2, 9)}`);
            const [habits, setHabits] = useState([]);
            const [completions, setCompletions] = useState({});
            const [dailyNotes, setDailyNotes] = useState({}); // { "habitId_dateKey": "note text" }
            const [darkMode, setDarkMode] = useState(() => localStorage.getItem('theme') === 'dark');
            const [status, setStatus] = useState('offline');

            const [currentDate, setCurrentDate] = useState(new Date());
            const [selectedDate, setSelectedDate] = useState(new Date());
            
            // Modal States
            const [isModalOpen, setIsModalOpen] = useState(false);
            const [editingHabit, setEditingHabit] = useState(null);
            const [detailHabit, setDetailHabit] = useState(null); // For Long Press

            // --- EFFECTS ---
            useEffect(() => { localStorage.setItem('habit_user_id', userId); }, [userId]);
            
            useEffect(() => {
                if (darkMode) { document.documentElement.classList.add('dark'); localStorage.setItem('theme', 'dark'); }
                else { document.documentElement.classList.remove('dark'); localStorage.setItem('theme', 'light'); }
            }, [darkMode]);

            useEffect(() => {
                const fetchData = async () => {
                    setStatus('saving');
                    const { data, error } = await supabase.from('user_data').select('*').eq('user_id', userId).single();
                    if (data) {
                        setHabits(data.habits || []);
                        setCompletions(data.completions || {});
                        setDailyNotes(data.notes || {}); // Assuming we add a notes column or store in json
                        setStatus('saved');
                    } else { await saveDataToSupabase(habits, completions, dailyNotes); }
                };
                fetchData();
            }, [userId]);

            // --- SAVING ---
            const saveDataToSupabase = async (h, c, n) => {
                setStatus('saving');
                // We store notes inside the JSONB or a new column. For simplicity, let's append to the existing object structure if we can, 
                // but since the table schema is fixed, we'll store 'notes' inside the 'habits' JSON or just reuse the logic. 
                // *Self-correction*: The SQL schema I gave you has columns: user_id, habits, completions. 
                // I will pack notes into 'completions' object to avoid SQL errors, or just ignore saving notes to cloud for now if schema isn't changed.
                // BETTER: Let's assume the 'habits' column is flexible JSON. I'll save notes inside the 'habits' payload or 'completions' payload.
                // Let's pack notes into `completions` under a special key `_notes` to be safe without altering table.
                const payloadCompletions = { ...c, _notes: n }; 
                
                const { error } = await supabase.from('user_data').upsert({ 
                    user_id: userId, 
                    habits: h, 
                    completions: payloadCompletions 
                });
                if (error) { console.error(error); setStatus('error'); } else setStatus('saved');
            };

            const updateData = (newHabits, newCompletions, newNotes) => {
                setHabits(newHabits); setCompletions(newCompletions); setDailyNotes(newNotes);
                saveDataToSupabase(newHabits, newCompletions, newNotes);
            };

            // --- HANDLERS ---
            const handleSaveHabit = (habit) => {
                const newHabits = habit.id && habits.some(h => h.id === habit.id) 
                    ? habits.map(h => h.id === habit.id ? habit : h) 
                    : [...habits, { ...habit, id: Date.now().toString() }];
                updateData(newHabits, completions, dailyNotes);
            };

            const handleDeleteHabit = (id) => updateData(habits.filter(h => h.id !== id), completions, dailyNotes);

            const toggleHabit = (id, dateKey) => {
                const current = completions[dateKey] || [];
                const newC = { ...completions, [dateKey]: current.includes(id) ? current.filter(x => x !== id) : [...current, id] };
                updateData(habits, newC, dailyNotes);
            };

            const handleSaveNote = (habitId, text) => {
                const key = `${habitId}_${selectedDateKey}`;
                const newNotes = { ...dailyNotes, [key]: text };
                updateData(habits, completions, newNotes);
            };

            // --- VIEW LOGIC ---
            const year = currentDate.getFullYear();
            const month = currentDate.getMonth();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const firstDay = new Date(year, month, 1).getDay();
            const selectedDateKey = formatDateKey(selectedDate);
            const todayKey = formatDateKey(new Date());

            const getHabitProgress = (id) => {
                let count = 0;
                for(let d=1; d<=daysInMonth; d++) {
                    const k = `${year}-${String(month+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                    if(completions[k]?.includes(id)) count++;
                }
                return Math.round((count / daysInMonth) * 100);
            };

            // Filter Habits for Selected Date
            const todaysHabits = habits.filter(h => {
                // 1. If it's a one-off task, only show on target date
                if (h.isTask) return h.targetDate === selectedDateKey;
                // 2. If it's a habit, check frequency
                if (h.frequency && !h.frequency.includes(selectedDate.getDay())) return false;
                return true;
            }).sort((a, b) => {
                // Sort: Habits with Time first, then alphabetically
                if (a.time && !b.time) return -1;
                if (!a.time && b.time) return 1;
                if (a.time && b.time) return a.time.localeCompare(b.time);
                return 0;
            });

            const renderCalendar = () => {
                const days = [];
                for(let i=0; i<firstDay; i++) days.push(<div key={`empty-${i}`} className="h-full bg-gray-50/50 dark:bg-dark-900 border-b border-r border-gray-100 dark:border-dark-700"></div>);
                for(let d=1; d<=daysInMonth; d++) {
                    const date = new Date(year, month, d);
                    const k = formatDateKey(date);
                    const dayData = completions[k] || [];
                    const isToday = k === todayKey;
                    const isSelected = k === selectedDateKey;
                    
                    days.push(
                        <div key={d} onClick={() => setSelectedDate(date)} className={`h-16 md:h-24 p-1 md:p-2 border-b border-r border-gray-100 dark:border-dark-700 cursor-pointer relative transition-colors ${isSelected ? 'bg-indigo-50/60 dark:bg-indigo-900/20' : 'hover:bg-gray-50 dark:hover:bg-dark-800'}`}>
                            <div className="flex justify-between items-center">
                                <span className={`w-6 h-6 flex items-center justify-center rounded-full text-xs font-bold ${isToday ? 'bg-indigo-600 text-white' : isSelected ? 'text-indigo-600 dark:text-indigo-400' : 'text-gray-500 dark:text-gray-400'}`}>{d}</span>
                                {dayData.length > 0 && <div className="w-1.5 h-1.5 rounded-full bg-emerald-400"></div>}
                            </div>
                            <div className="mt-1 flex flex-wrap gap-0.5">{dayData.slice(0, 4).map(id => { const h = habits.find(x => x.id === id); return h ? <span key={id} className="text-[10px]">{h.icon}</span> : null; })}</div>
                        </div>
                    );
                }
                return days;
            };

            // Long Press Logic
            const longPressTimer = useRef(null);
            const handleTouchStart = (h) => { longPressTimer.current = setTimeout(() => { setDetailHabit(h); longPressTimer.current = null; }, 600); };
            const handleTouchEnd = () => { if (longPressTimer.current) { clearTimeout(longPressTimer.current); longPressTimer.current = null; } };

            return (
                <div className="flex flex-col md:flex-row h-screen overflow-hidden selection:bg-indigo-100 text-slate-800 dark:text-slate-200 font-sans">
                    {/* LEFT SIDEBAR (Stats) */}
                    <div className="w-80 bg-white dark:bg-dark-800 border-r border-gray-200 dark:border-dark-700 hidden md:flex flex-col z-20">
                        <div className="p-6 border-b border-gray-100 dark:border-dark-700 flex items-center justify-between">
                            <div className="flex items-center gap-3">
                                <div className="bg-indigo-600 text-white p-2 rounded-lg"><Trophy size={20} /></div>
                                <div><h1 className="font-bold text-lg leading-tight dark:text-white">Habit OS</h1><p className="text-xs text-indigo-500 font-medium">{status === 'saving' ? 'Syncing...' : 'Cloud Active'}</p></div>
                            </div>
                        </div>
                        <div className="p-4 bg-indigo-50 dark:bg-indigo-900/20 mx-4 mt-4 rounded-xl border border-indigo-100 dark:border-indigo-900/30">
                            <p className="text-[10px] text-indigo-400 font-bold uppercase mb-1">Backup ID</p>
                            <p className="font-mono text-xs text-indigo-800 dark:text-indigo-300 break-all select-all cursor-pointer" onClick={() => navigator.clipboard.writeText(userId)}>{userId}</p>
                            <button onClick={() => {const c = prompt("Backup ID:"); if(c) {setUserId(c); window.location.reload();}}} className="text-[10px] text-indigo-500 underline mt-2">Restore?</button>
                        </div>
                        <div className="flex-1 overflow-y-auto p-4 scrollbar-thin">
                            <div className="flex justify-between items-end mb-4 px-2"><h2 className="text-xs font-bold text-gray-400 uppercase tracking-wider">All Habits</h2><button onClick={() => { setEditingHabit(null); setIsModalOpen(true); }} className="text-indigo-600 hover:bg-indigo-50 dark:hover:bg-dark-700 p-1 rounded"><Plus size={18} /></button></div>
                            <div className="space-y-3">{habits.filter(h => !h.isTask).map(h => { const p = getHabitProgress(h.id); return (<div key={h.id} className="group p-3 rounded-xl hover:bg-gray-50 dark:hover:bg-dark-700 border border-transparent hover:border-gray-100 dark:hover:border-dark-600 transition-all"><div className="flex items-center justify-between mb-1"><div className="flex items-center gap-3"><span className="text-xl">{h.icon}</span><span className="text-sm font-medium dark:text-gray-200">{h.name}</span></div><div className="flex items-center gap-2"><span className="text-xs font-bold text-gray-400">{p}%</span><button onClick={() => { setEditingHabit(h); setIsModalOpen(true); }} className="opacity-0 group-hover:opacity-100 text-gray-400 hover:text-indigo-600"><Edit2 size={12} /></button></div></div><MiniProgressBar percentage={p} colorClass={h.color.bar} /></div>); })}</div>
                        </div>
                    </div>

                    {/* CENTER (Calendar) */}
                    <div className="flex-1 flex flex-col bg-white dark:bg-dark-900 h-[50%] md:h-full relative order-1">
                        <header className="px-4 md:px-6 py-3 md:py-4 flex items-center justify-between border-b border-gray-100 dark:border-dark-700 z-10 bg-white dark:bg-dark-900">
                            <div className="flex items-center gap-2 md:gap-4"><h2 className="text-lg md:text-xl font-bold text-gray-800 dark:text-white">{currentDate.toLocaleString('default', { month: 'long' })} {year}</h2><div className="flex bg-gray-100 dark:bg-dark-800 rounded-lg p-1"><button onClick={() => setCurrentDate(new Date(year, month - 1, 1))} className="p-1 hover:bg-white dark:hover:bg-dark-700 rounded shadow-sm"><ChevronLeft size={16}/></button><button onClick={() => setCurrentDate(new Date(year, month + 1, 1))} className="p-1 hover:bg-white dark:hover:bg-dark-700 rounded shadow-sm"><ChevronRight size={16}/></button></div></div>
                            <div className="flex items-center gap-3">
                                <button onClick={() => setDarkMode(!darkMode)} className="p-2 text-gray-400 hover:text-indigo-500 transition-colors">{darkMode ? <Sun size={18} /> : <Moon size={18} />}</button>
                                <button onClick={() => {const now=new Date(); setCurrentDate(now); setSelectedDate(now);}} className="text-xs font-bold bg-indigo-50 dark:bg-indigo-900/30 text-indigo-600 dark:text-indigo-400 px-3 py-1.5 rounded-full">Today</button>
                            </div>
                        </header>
                        <div className="flex-1 overflow-auto min-h-0"><div className="grid grid-cols-7 border-b border-gray-100 dark:border-dark-700 sticky top-0 bg-white dark:bg-dark-900 z-10 text-center py-2 text-xs font-bold text-gray-400 uppercase">{['S', 'M', 'T', 'W', 'T', 'F', 'S'].map(d => <div key={d}>{d}</div>)}</div><div className="grid grid-cols-7 auto-rows-fr">{renderCalendar()}</div></div>
                        <div className="h-32 md:h-44 bg-white dark:bg-dark-900 border-t border-gray-100 dark:border-dark-700 p-2 md:p-4 flex flex-col flex-shrink-0"><div className="flex items-center gap-2 mb-2"><Cloud size={16} className="text-gray-400" /><h3 className="text-xs font-bold text-gray-500 uppercase tracking-wider">Consistency</h3></div><div className="flex-1"><ConsistencyChart completions={completions} habits={habits} /></div></div>
                    </div>

                    {/* RIGHT SIDEBAR (Agenda - Bottom on Mobile) */}
                    <div className="w-full md:w-96 bg-gray-50 dark:bg-dark-800/50 border-t md:border-t-0 md:border-l border-gray-200 dark:border-dark-700 flex flex-col z-20 shadow-[0_-4px_6px_-1px_rgba(0,0,0,0.1)] md:shadow-xl h-[50%] md:h-full order-2">
                        <div className="px-6 py-4 md:p-6 border-b border-gray-200/50 dark:border-dark-700 flex justify-between items-center backdrop-blur-md sticky top-0 z-10">
                            <div><h2 className="text-xl md:text-2xl font-bold text-gray-900 dark:text-white">{selectedDate.toLocaleDateString('en-US', { weekday: 'long' })}</h2><p className="text-gray-500 dark:text-gray-400 text-xs md:text-sm">{selectedDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric' })}</p></div>
                            <div className="md:hidden"><button onClick={() => { setEditingHabit(null); setIsModalOpen(true); }} className="bg-indigo-600 text-white p-2 rounded-lg shadow-sm"><Plus size={18} /></button></div>
                        </div>
                        
                        <div className="flex-1 overflow-y-auto p-4 md:p-6 pb-20 md:pb-6 scrollbar-thin">
                            {todaysHabits.length === 0 ? (
                                <div className="text-center py-10 text-gray-400 dark:text-gray-600"><div className="text-4xl mb-2">üèñÔ∏è</div><p className="text-sm font-medium">No tasks scheduled.</p></div>
                            ) : (
                                <div className="space-y-3">
                                    {todaysHabits.map(h => { 
                                        const isDone = completions[selectedDateKey]?.includes(h.id);
                                        const streak = calculateStreak(h.id, completions);
                                        
                                        return (
                                            <div 
                                                key={h.id}
                                                onMouseDown={() => handleTouchStart(h)} onMouseUp={handleTouchEnd} onMouseLeave={handleTouchEnd}
                                                onTouchStart={() => handleTouchStart(h)} onTouchEnd={handleTouchEnd}
                                                onClick={() => { if(!longPressTimer.current) toggleHabit(h.id, selectedDateKey); }}
                                                className={`no-select relative group flex items-center p-3.5 rounded-2xl cursor-pointer border transition-all duration-200 transform active:scale-95 ${isDone ? 'bg-white/50 dark:bg-dark-700/50 border-transparent opacity-70' : 'bg-white dark:bg-dark-700 border-gray-100 dark:border-dark-600 shadow-sm'}`}
                                            >
                                                {/* Checkbox */}
                                                <div className={`w-6 h-6 rounded-lg mr-3 flex items-center justify-center transition-colors ${isDone ? `${h.color.dot} text-white` : 'bg-gray-100 dark:bg-dark-800 text-transparent'}`}>
                                                    <Check size={14} strokeWidth={3} />
                                                </div>
                                                
                                                {/* Content */}
                                                <div className="flex-1 min-w-0">
                                                    <div className="flex items-center justify-between">
                                                        <div className="flex items-center gap-2">
                                                            <span className="text-lg">{h.icon}</span>
                                                            <span className={`text-sm font-bold truncate ${isDone ? 'line-through text-gray-400 dark:text-gray-500' : 'text-gray-700 dark:text-gray-200'}`}>{h.name}</span>
                                                        </div>
                                                        {/* Streak Fire */}
                                                        {!isDone && streak > 2 && <div className="flex items-center text-[10px] font-bold text-orange-500 gap-0.5"><Fire size={12} /> {streak}</div>}
                                                    </div>
                                                    {/* Time & Task Label */}
                                                    <div className="flex items-center gap-2 mt-0.5">
                                                        {h.time && <span className="flex items-center gap-1 text-[10px] font-bold text-indigo-500 bg-indigo-50 dark:bg-indigo-900/30 px-1.5 py-0.5 rounded"><Clock size={10} /> {h.time}</span>}
                                                        {h.isTask && <span className="text-[9px] font-bold bg-gray-100 dark:bg-dark-600 text-gray-500 px-1.5 py-0.5 rounded uppercase tracking-wide">One-Off</span>}
                                                    </div>
                                                </div>
                                            </div>
                                        ); 
                                    })}
                                </div>
                            )}
                            
                            {/* Mobile Restore & ID */}
                            <div className="md:hidden pt-8 text-center mt-4">
                                <p className="text-[10px] text-gray-300 dark:text-dark-600 font-mono mb-1">{userId}</p>
                                <button onClick={() => {const c = prompt("Backup ID:"); if(c) {setUserId(c); window.location.reload();}}} className="text-[10px] text-gray-400 underline">Restore Data</button>
                            </div>
                        </div>

                        <div className="hidden md:block p-4 border-t border-gray-200 dark:border-dark-700 bg-white dark:bg-dark-900">
                            <button onClick={() => { setEditingHabit(null); setIsModalOpen(true); }} className="w-full py-3 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl font-bold shadow-lg transition-transform hover:-translate-y-0.5">+ Add Item</button>
                        </div>
                    </div>
                    
                    <HabitModal isOpen={isModalOpen} onClose={() => setIsModalOpen(false)} onSave={handleSaveHabit} onDelete={handleDeleteHabit} initialData={editingHabit} />
                    <NoteModal isOpen={!!detailHabit} onClose={() => setDetailHabit(null)} habit={detailHabit} streak={detailHabit ? calculateStreak(detailHabit.id, completions) : 0} notes={detailHabit ? dailyNotes[`${detailHabit.id}_${selectedDateKey}`] : ''} onSaveNote={handleSaveNote} />
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
